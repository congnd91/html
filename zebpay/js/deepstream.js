(function(f){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=f()}else if(typeof define==="function"&&define.amd){define([],f)}else{var g;if(typeof window!=="undefined"){g=window}else if(typeof global!=="undefined"){g=global}else if(typeof self!=="undefined"){g=self}else{g=this}g.deepstream=f()}})(function(){var define,module,exports;return(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(_dereq_,module,exports){},{}],2:[function(_dereq_,module,exports){module.exports=Emitter;function Emitter(obj){if(obj)return mixin(obj);};function mixin(obj){for(var key in Emitter.prototype){obj[key]=Emitter.prototype[key];}
return obj;}
Emitter.prototype.on=Emitter.prototype.addEventListener=function(event,fn){this._callbacks=this._callbacks||{};(this._callbacks[event]=this._callbacks[event]||[]).push(fn);return this;};Emitter.prototype.once=function(event,fn){var self=this;this._callbacks=this._callbacks||{};function on(){self.off(event,on);fn.apply(this,arguments);}
on.fn=fn;this.on(event,on);return this;};Emitter.prototype.off=Emitter.prototype.removeListener=Emitter.prototype.removeAllListeners=Emitter.prototype.removeEventListener=function(event,fn){this._callbacks=this._callbacks||{};if(0==arguments.length){this._callbacks={};return this;}
var callbacks=this._callbacks[event];if(!callbacks)return this;if(1==arguments.length){delete this._callbacks[event];return this;}
var cb;for(var i=0;i<callbacks.length;i++){cb=callbacks[i];if(cb===fn||cb.fn===fn){callbacks.splice(i,1);break;}}
return this;};Emitter.prototype.emit=function(event){this._callbacks=this._callbacks||{};var args=[].slice.call(arguments,1),callbacks=this._callbacks[event];if(callbacks){callbacks=callbacks.slice(0);for(var i=0,len=callbacks.length;i<len;++i){callbacks[i].apply(this,args);}}
return this;};Emitter.prototype.listeners=function(event){this._callbacks=this._callbacks||{};return this._callbacks[event]||[];};Emitter.prototype.hasListeners=function(event){return!!this.listeners(event).length;};},{}],3:[function(_dereq_,module,exports){var process=module.exports={};var cachedSetTimeout;var cachedClearTimeout;function defaultSetTimout(){throw new Error('setTimeout has not been defined');}
function defaultClearTimeout(){throw new Error('clearTimeout has not been defined');}
(function(){try{if(typeof setTimeout==='function'){cachedSetTimeout=setTimeout;}else{cachedSetTimeout=defaultSetTimout;}}catch(e){cachedSetTimeout=defaultSetTimout;}
try{if(typeof clearTimeout==='function'){cachedClearTimeout=clearTimeout;}else{cachedClearTimeout=defaultClearTimeout;}}catch(e){cachedClearTimeout=defaultClearTimeout;}}())
function runTimeout(fun){if(cachedSetTimeout===setTimeout){return setTimeout(fun,0);}
if((cachedSetTimeout===defaultSetTimout||!cachedSetTimeout)&&setTimeout){cachedSetTimeout=setTimeout;return setTimeout(fun,0);}
try{return cachedSetTimeout(fun,0);}catch(e){try{return cachedSetTimeout.call(null,fun,0);}catch(e){return cachedSetTimeout.call(this,fun,0);}}}
function runClearTimeout(marker){if(cachedClearTimeout===clearTimeout){return clearTimeout(marker);}
if((cachedClearTimeout===defaultClearTimeout||!cachedClearTimeout)&&clearTimeout){cachedClearTimeout=clearTimeout;return clearTimeout(marker);}
try{return cachedClearTimeout(marker);}catch(e){try{return cachedClearTimeout.call(null,marker);}catch(e){return cachedClearTimeout.call(this,marker);}}}
var queue=[];var draining=false;var currentQueue;var queueIndex=-1;function cleanUpNextTick(){if(!draining||!currentQueue){return;}
draining=false;if(currentQueue.length){queue=currentQueue.concat(queue);}else{queueIndex=-1;}
if(queue.length){drainQueue();}}
function drainQueue(){if(draining){return;}
var timeout=runTimeout(cleanUpNextTick);draining=true;var len=queue.length;while(len){currentQueue=queue;queue=[];while(++queueIndex<len){if(currentQueue){currentQueue[queueIndex].run();}}
queueIndex=-1;len=queue.length;}
currentQueue=null;draining=false;runClearTimeout(timeout);}
process.nextTick=function(fun){var args=new Array(arguments.length-1);if(arguments.length>1){for(var i=1;i<arguments.length;i++){args[i-1]=arguments[i];}}
queue.push(new Item(fun,args));if(queue.length===1&&!draining){runTimeout(drainQueue);}};function Item(fun,array){this.fun=fun;this.array=array;}
Item.prototype.run=function(){this.fun.apply(null,this.array);};process.title='browser';process.browser=true;process.env={};process.argv=[];process.version='';process.versions={};function noop(){}
process.on=noop;process.addListener=noop;process.once=noop;process.off=noop;process.removeListener=noop;process.removeAllListeners=noop;process.emit=noop;process.binding=function(name){throw new Error('process.binding is not supported');};process.cwd=function(){return '/'};process.chdir=function(dir){throw new Error('process.chdir is not supported');};process.umask=function(){return 0;};},{}],4:[function(_dereq_,module,exports){(function(global){/*!https://mths.be/punycode v1.4.1 by @mathias*/;(function(root){var freeExports=typeof exports=='object'&&exports&&!exports.nodeType&&exports;var freeModule=typeof module=='object'&&module&&!module.nodeType&&module;var freeGlobal=typeof global=='object'&&global;if(freeGlobal.global===freeGlobal||freeGlobal.window===freeGlobal||freeGlobal.self===freeGlobal){root=freeGlobal;}
var punycode,maxInt=2147483647,base=36,tMin=1,tMax=26,skew=38,damp=700,initialBias=72,initialN=128,delimiter='-',regexPunycode=/^xn--/,regexNonASCII=/[^\x20-\x7E]/,regexSeparators=/[\x2E\u3002\uFF0E\uFF61]/g,errors={'overflow':'Overflow: input needs wider integers to process','not-basic':'Illegal input >= 0x80 (not a basic code point)','invalid-input':'Invalid input'},baseMinusTMin=base-tMin,floor=Math.floor,stringFromCharCode=String.fromCharCode,key;function error(type){throw new RangeError(errors[type]);}
function map(array,fn){var length=array.length;var result=[];while(length--){result[length]=fn(array[length]);}
return result;}
function mapDomain(string,fn){var parts=string.split('@');var result='';if(parts.length>1){result=parts[0]+'@';string=parts[1];}
string=string.replace(regexSeparators,'\x2E');var labels=string.split('.');var encoded=map(labels,fn).join('.');return result+encoded;}
function ucs2decode(string){var output=[],counter=0,length=string.length,value,extra;while(counter<length){value=string.charCodeAt(counter++);if(value>=0xD800&&value<=0xDBFF&&counter<length){extra=string.charCodeAt(counter++);if((extra&0xFC00)==0xDC00){output.push(((value&0x3FF)<<10)+(extra&0x3FF)+0x10000);}else{output.push(value);counter--;}}else{output.push(value);}}
return output;}
function ucs2encode(array){return map(array,function(value){var output='';if(value>0xFFFF){value-=0x10000;output+=stringFromCharCode(value>>>10&0x3FF|0xD800);value=0xDC00|value&0x3FF;}
output+=stringFromCharCode(value);return output;}).join('');}
function basicToDigit(codePoint){if(codePoint-48<10){return codePoint-22;}
if(codePoint-65<26){return codePoint-65;}
if(codePoint-97<26){return codePoint-97;}
return base;}
function digitToBasic(digit,flag){return digit+22+75*(digit<26)-((flag!=0)<<5);}
function adapt(delta,numPoints,firstTime){var k=0;delta=firstTime?floor(delta/damp):delta>>1;delta+=floor(delta/numPoints);for(;delta>baseMinusTMin*tMax>>1;k+=base){delta=floor(delta/baseMinusTMin);}
return floor(k+(baseMinusTMin+1)*delta/(delta+skew));}
function decode(input){var output=[],inputLength=input.length,out,i=0,n=initialN,bias=initialBias,basic,j,index,oldi,w,k,digit,t,baseMinusT;basic=input.lastIndexOf(delimiter);if(basic<0){basic=0;}
for(j=0;j<basic;++j){if(input.charCodeAt(j)>=0x80){error('not-basic');}
output.push(input.charCodeAt(j));}
for(index=basic>0?basic+1:0;index<inputLength;){for(oldi=i,w=1,k=base;;k+=base){if(index>=inputLength){error('invalid-input');}
digit=basicToDigit(input.charCodeAt(index++));if(digit>=base||digit>floor((maxInt-i)/w)){error('overflow');}
i+=digit*w;t=k<=bias?tMin:(k>=bias+tMax?tMax:k-bias);if(digit<t){break;}
baseMinusT=base-t;if(w>floor(maxInt/baseMinusT)){error('overflow');}
w*=baseMinusT;}
out=output.length+1;bias=adapt(i-oldi,out,oldi==0);if(floor(i/out)>maxInt-n){error('overflow');}
n+=floor(i/out);i%=out;output.splice(i++,0,n);}
return ucs2encode(output);}
function encode(input){var n,delta,handledCPCount,basicLength,bias,j,m,q,k,t,currentValue,output=[],inputLength,handledCPCountPlusOne,baseMinusT,qMinusT;input=ucs2decode(input);inputLength=input.length;n=initialN;delta=0;bias=initialBias;for(j=0;j<inputLength;++j){currentValue=input[j];if(currentValue<0x80){output.push(stringFromCharCode(currentValue));}}
handledCPCount=basicLength=output.length;if(basicLength){output.push(delimiter);}
while(handledCPCount<inputLength){for(m=maxInt,j=0;j<inputLength;++j){currentValue=input[j];if(currentValue>=n&&currentValue<m){m=currentValue;}}
handledCPCountPlusOne=handledCPCount+1;if(m-n>floor((maxInt-delta)/handledCPCountPlusOne)){error('overflow');}
delta+=(m-n)*handledCPCountPlusOne;n=m;for(j=0;j<inputLength;++j){currentValue=input[j];if(currentValue<n&&++delta>maxInt){error('overflow');}
if(currentValue==n){for(q=delta,k=base;;k+=base){t=k<=bias?tMin:(k>=bias+tMax?tMax:k-bias);if(q<t){break;}
qMinusT=q-t;baseMinusT=base-t;output.push(stringFromCharCode(digitToBasic(t+qMinusT%baseMinusT,0)));q=floor(qMinusT/baseMinusT);}
output.push(stringFromCharCode(digitToBasic(q,0)));bias=adapt(delta,handledCPCountPlusOne,handledCPCount==basicLength);delta=0;++handledCPCount;}}
++delta;++n;}
return output.join('');}
function toUnicode(input){return mapDomain(input,function(string){return regexPunycode.test(string)?decode(string.slice(4).toLowerCase()):string;});}
function toASCII(input){return mapDomain(input,function(string){return regexNonASCII.test(string)?'xn--'+encode(string):string;});}
punycode={'version':'1.4.1','ucs2':{'decode':ucs2decode,'encode':ucs2encode},'decode':decode,'encode':encode,'toASCII':toASCII,'toUnicode':toUnicode};if(typeof define=='function'&&typeof define.amd=='object'&&define.amd){define('punycode',function(){return punycode;});}else if(freeExports&&freeModule){if(module.exports==freeExports){freeModule.exports=punycode;}else{for(key in punycode){punycode.hasOwnProperty(key)&&(freeExports[key]=punycode[key]);}}}else{root.punycode=punycode;}}(this));}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{}],5:[function(_dereq_,module,exports){'use strict';function hasOwnProperty(obj,prop){return Object.prototype.hasOwnProperty.call(obj,prop);}
module.exports=function(qs,sep,eq,options){sep=sep||'&';eq=eq||'=';var obj={};if(typeof qs!=='string'||qs.length===0){return obj;}
var regexp=/\+/g;qs=qs.split(sep);var maxKeys=1000;if(options&&typeof options.maxKeys==='number'){maxKeys=options.maxKeys;}
var len=qs.length;if(maxKeys>0&&len>maxKeys){len=maxKeys;}
for(var i=0;i<len;++i){var x=qs[i].replace(regexp,'%20'),idx=x.indexOf(eq),kstr,vstr,k,v;if(idx>=0){kstr=x.substr(0,idx);vstr=x.substr(idx+1);}else{kstr=x;vstr='';}
k=decodeURIComponent(kstr);v=decodeURIComponent(vstr);if(!hasOwnProperty(obj,k)){obj[k]=v;}else if(isArray(obj[k])){obj[k].push(v);}else{obj[k]=[obj[k],v];}}
return obj;};var isArray=Array.isArray||function(xs){return Object.prototype.toString.call(xs)==='[object Array]';};},{}],6:[function(_dereq_,module,exports){'use strict';var stringifyPrimitive=function(v){switch(typeof v){case 'string':return v;case 'boolean':return v?'true':'false';case 'number':return isFinite(v)?v:'';default:return '';}};module.exports=function(obj,sep,eq,name){sep=sep||'&';eq=eq||'=';if(obj===null){obj=undefined;}
if(typeof obj==='object'){return map(objectKeys(obj),function(k){var ks=encodeURIComponent(stringifyPrimitive(k))+eq;if(isArray(obj[k])){return map(obj[k],function(v){return ks+encodeURIComponent(stringifyPrimitive(v));}).join(sep);}else{return ks+encodeURIComponent(stringifyPrimitive(obj[k]));}}).join(sep);}
if(!name)return '';return encodeURIComponent(stringifyPrimitive(name))+eq+
encodeURIComponent(stringifyPrimitive(obj));};var isArray=Array.isArray||function(xs){return Object.prototype.toString.call(xs)==='[object Array]';};function map(xs,f){if(xs.map)return xs.map(f);var res=[];for(var i=0;i<xs.length;i++){res.push(f(xs[i],i));}
return res;}
var objectKeys=Object.keys||function(obj){var res=[];for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key))res.push(key);}
return res;};},{}],7:[function(_dereq_,module,exports){'use strict';exports.decode=exports.parse=_dereq_('./decode');exports.encode=exports.stringify=_dereq_('./encode');},{"./decode":5,"./encode":6}],8:[function(_dereq_,module,exports){'use strict';var punycode=_dereq_('punycode');var util=_dereq_('./util');exports.parse=urlParse;exports.resolve=urlResolve;exports.resolveObject=urlResolveObject;exports.format=urlFormat;exports.Url=Url;function Url(){this.protocol=null;this.slashes=null;this.auth=null;this.host=null;this.port=null;this.hostname=null;this.hash=null;this.search=null;this.query=null;this.pathname=null;this.path=null;this.href=null;}
var protocolPattern=/^([a-z0-9.+-]+:)/i,portPattern=/:[0-9]*$/,simplePathPattern=/^(\/\/?(?!\/)[^\?\s]*)(\?[^\s]*)?$/,delims=['<','>','"','`',' ','\r','\n','\t'],unwise=['{','}','|','\\','^','`'].concat(delims),autoEscape=['\''].concat(unwise),nonHostChars=['%','/','?',';','#'].concat(autoEscape),hostEndingChars=['/','?','#'],hostnameMaxLen=255,hostnamePartPattern=/^[+a-z0-9A-Z_-]{0,63}$/,hostnamePartStart=/^([+a-z0-9A-Z_-]{0,63})(.*)$/,unsafeProtocol={'javascript':true,'javascript:':true},hostlessProtocol={'javascript':true,'javascript:':true},slashedProtocol={'http':true,'https':true,'ftp':true,'gopher':true,'file':true,'http:':true,'https:':true,'ftp:':true,'gopher:':true,'file:':true},querystring=_dereq_('querystring');function urlParse(url,parseQueryString,slashesDenoteHost){if(url&&util.isObject(url)&&url instanceof Url)return url;var u=new Url;u.parse(url,parseQueryString,slashesDenoteHost);return u;}
Url.prototype.parse=function(url,parseQueryString,slashesDenoteHost){if(!util.isString(url)){throw new TypeError("Parameter 'url' must be a string, not "+typeof url);}
var queryIndex=url.indexOf('?'),splitter=(queryIndex!==-1&&queryIndex<url.indexOf('#'))?'?':'#',uSplit=url.split(splitter),slashRegex=/\\/g;uSplit[0]=uSplit[0].replace(slashRegex,'/');url=uSplit.join(splitter);var rest=url;rest=rest.trim();if(!slashesDenoteHost&&url.split('#').length===1){var simplePath=simplePathPattern.exec(rest);if(simplePath){this.path=rest;this.href=rest;this.pathname=simplePath[1];if(simplePath[2]){this.search=simplePath[2];if(parseQueryString){this.query=querystring.parse(this.search.substr(1));}else{this.query=this.search.substr(1);}}else if(parseQueryString){this.search='';this.query={};}
return this;}}
var proto=protocolPattern.exec(rest);if(proto){proto=proto[0];var lowerProto=proto.toLowerCase();this.protocol=lowerProto;rest=rest.substr(proto.length);}
if(slashesDenoteHost||proto||rest.match(/^\/\/[^@\/]+@[^@\/]+/)){var slashes=rest.substr(0,2)==='//';if(slashes&&!(proto&&hostlessProtocol[proto])){rest=rest.substr(2);this.slashes=true;}}
if(!hostlessProtocol[proto]&&(slashes||(proto&&!slashedProtocol[proto]))){var hostEnd=-1;for(var i=0;i<hostEndingChars.length;i++){var hec=rest.indexOf(hostEndingChars[i]);if(hec!==-1&&(hostEnd===-1||hec<hostEnd))
hostEnd=hec;}
var auth,atSign;if(hostEnd===-1){atSign=rest.lastIndexOf('@');}else{atSign=rest.lastIndexOf('@',hostEnd);}
if(atSign!==-1){auth=rest.slice(0,atSign);rest=rest.slice(atSign+1);this.auth=decodeURIComponent(auth);}
hostEnd=-1;for(var i=0;i<nonHostChars.length;i++){var hec=rest.indexOf(nonHostChars[i]);if(hec!==-1&&(hostEnd===-1||hec<hostEnd))
hostEnd=hec;}
if(hostEnd===-1)
hostEnd=rest.length;this.host=rest.slice(0,hostEnd);rest=rest.slice(hostEnd);this.parseHost();this.hostname=this.hostname||'';var ipv6Hostname=this.hostname[0]==='['&&this.hostname[this.hostname.length-1]===']';if(!ipv6Hostname){var hostparts=this.hostname.split(/\./);for(var i=0,l=hostparts.length;i<l;i++){var part=hostparts[i];if(!part)continue;if(!part.match(hostnamePartPattern)){var newpart='';for(var j=0,k=part.length;j<k;j++){if(part.charCodeAt(j)>127){newpart+='x';}else{newpart+=part[j];}}
if(!newpart.match(hostnamePartPattern)){var validParts=hostparts.slice(0,i);var notHost=hostparts.slice(i+1);var bit=part.match(hostnamePartStart);if(bit){validParts.push(bit[1]);notHost.unshift(bit[2]);}
if(notHost.length){rest='/'+notHost.join('.')+rest;}
this.hostname=validParts.join('.');break;}}}}
if(this.hostname.length>hostnameMaxLen){this.hostname='';}else{this.hostname=this.hostname.toLowerCase();}
if(!ipv6Hostname){this.hostname=punycode.toASCII(this.hostname);}
var p=this.port?':'+this.port:'';var h=this.hostname||'';this.host=h+p;this.href+=this.host;if(ipv6Hostname){this.hostname=this.hostname.substr(1,this.hostname.length-2);if(rest[0]!=='/'){rest='/'+rest;}}}
if(!unsafeProtocol[lowerProto]){for(var i=0,l=autoEscape.length;i<l;i++){var ae=autoEscape[i];if(rest.indexOf(ae)===-1)
continue;var esc=encodeURIComponent(ae);if(esc===ae){esc=escape(ae);}
rest=rest.split(ae).join(esc);}}
var hash=rest.indexOf('#');if(hash!==-1){this.hash=rest.substr(hash);rest=rest.slice(0,hash);}
var qm=rest.indexOf('?');if(qm!==-1){this.search=rest.substr(qm);this.query=rest.substr(qm+1);if(parseQueryString){this.query=querystring.parse(this.query);}
rest=rest.slice(0,qm);}else if(parseQueryString){this.search='';this.query={};}
if(rest)this.pathname=rest;if(slashedProtocol[lowerProto]&&this.hostname&&!this.pathname){this.pathname='/';}
if(this.pathname||this.search){var p=this.pathname||'';var s=this.search||'';this.path=p+s;}
this.href=this.format();return this;};function urlFormat(obj){if(util.isString(obj))obj=urlParse(obj);if(!(obj instanceof Url))return Url.prototype.format.call(obj);return obj.format();}
Url.prototype.format=function(){var auth=this.auth||'';if(auth){auth=encodeURIComponent(auth);auth=auth.replace(/%3A/i,':');auth+='@';}
var protocol=this.protocol||'',pathname=this.pathname||'',hash=this.hash||'',host=false,query='';if(this.host){host=auth+this.host;}else if(this.hostname){host=auth+(this.hostname.indexOf(':')===-1?this.hostname:'['+this.hostname+']');if(this.port){host+=':'+this.port;}}
if(this.query&&util.isObject(this.query)&&Object.keys(this.query).length){query=querystring.stringify(this.query);}
var search=this.search||(query&&('?'+query))||'';if(protocol&&protocol.substr(-1)!==':')protocol+=':';if(this.slashes||(!protocol||slashedProtocol[protocol])&&host!==false){host='//'+(host||'');if(pathname&&pathname.charAt(0)!=='/')pathname='/'+pathname;}else if(!host){host='';}
if(hash&&hash.charAt(0)!=='#')hash='#'+hash;if(search&&search.charAt(0)!=='?')search='?'+search;pathname=pathname.replace(/[?#]/g,function(match){return encodeURIComponent(match);});search=search.replace('#','%23');return protocol+host+pathname+search+hash;};function urlResolve(source,relative){return urlParse(source,false,true).resolve(relative);}
Url.prototype.resolve=function(relative){return this.resolveObject(urlParse(relative,false,true)).format();};function urlResolveObject(source,relative){if(!source)return relative;return urlParse(source,false,true).resolveObject(relative);}
Url.prototype.resolveObject=function(relative){if(util.isString(relative)){var rel=new Url();rel.parse(relative,false,true);relative=rel;}
var result=new Url();var tkeys=Object.keys(this);for(var tk=0;tk<tkeys.length;tk++){var tkey=tkeys[tk];result[tkey]=this[tkey];}
result.hash=relative.hash;if(relative.href===''){result.href=result.format();return result;}
if(relative.slashes&&!relative.protocol){var rkeys=Object.keys(relative);for(var rk=0;rk<rkeys.length;rk++){var rkey=rkeys[rk];if(rkey!=='protocol')
result[rkey]=relative[rkey];}
if(slashedProtocol[result.protocol]&&result.hostname&&!result.pathname){result.path=result.pathname='/';}
result.href=result.format();return result;}
if(relative.protocol&&relative.protocol!==result.protocol){if(!slashedProtocol[relative.protocol]){var keys=Object.keys(relative);for(var v=0;v<keys.length;v++){var k=keys[v];result[k]=relative[k];}
result.href=result.format();return result;}
result.protocol=relative.protocol;if(!relative.host&&!hostlessProtocol[relative.protocol]){var relPath=(relative.pathname||'').split('/');while(relPath.length&&!(relative.host=relPath.shift()));if(!relative.host)relative.host='';if(!relative.hostname)relative.hostname='';if(relPath[0]!=='')relPath.unshift('');if(relPath.length<2)relPath.unshift('');result.pathname=relPath.join('/');}else{result.pathname=relative.pathname;}
result.search=relative.search;result.query=relative.query;result.host=relative.host||'';result.auth=relative.auth;result.hostname=relative.hostname||relative.host;result.port=relative.port;if(result.pathname||result.search){var p=result.pathname||'';var s=result.search||'';result.path=p+s;}
result.slashes=result.slashes||relative.slashes;result.href=result.format();return result;}
var isSourceAbs=(result.pathname&&result.pathname.charAt(0)==='/'),isRelAbs=(relative.host||relative.pathname&&relative.pathname.charAt(0)==='/'),mustEndAbs=(isRelAbs||isSourceAbs||(result.host&&relative.pathname)),removeAllDots=mustEndAbs,srcPath=result.pathname&&result.pathname.split('/')||[],relPath=relative.pathname&&relative.pathname.split('/')||[],psychotic=result.protocol&&!slashedProtocol[result.protocol];if(psychotic){result.hostname='';result.port=null;if(result.host){if(srcPath[0]==='')srcPath[0]=result.host;else srcPath.unshift(result.host);}
result.host='';if(relative.protocol){relative.hostname=null;relative.port=null;if(relative.host){if(relPath[0]==='')relPath[0]=relative.host;else relPath.unshift(relative.host);}
relative.host=null;}
mustEndAbs=mustEndAbs&&(relPath[0]===''||srcPath[0]==='');}
if(isRelAbs){result.host=(relative.host||relative.host==='')?relative.host:result.host;result.hostname=(relative.hostname||relative.hostname==='')?relative.hostname:result.hostname;result.search=relative.search;result.query=relative.query;srcPath=relPath;}else if(relPath.length){if(!srcPath)srcPath=[];srcPath.pop();srcPath=srcPath.concat(relPath);result.search=relative.search;result.query=relative.query;}else if(!util.isNullOrUndefined(relative.search)){if(psychotic){result.hostname=result.host=srcPath.shift();var authInHost=result.host&&result.host.indexOf('@')>0?result.host.split('@'):false;if(authInHost){result.auth=authInHost.shift();result.host=result.hostname=authInHost.shift();}}
result.search=relative.search;result.query=relative.query;if(!util.isNull(result.pathname)||!util.isNull(result.search)){result.path=(result.pathname?result.pathname:'')+
(result.search?result.search:'');}
result.href=result.format();return result;}
if(!srcPath.length){result.pathname=null;if(result.search){result.path='/'+result.search;}else{result.path=null;}
result.href=result.format();return result;}
var last=srcPath.slice(-1)[0];var hasTrailingSlash=((result.host||relative.host||srcPath.length>1)&&(last==='.'||last==='..')||last==='');var up=0;for(var i=srcPath.length;i>=0;i--){last=srcPath[i];if(last==='.'){srcPath.splice(i,1);}else if(last==='..'){srcPath.splice(i,1);up++;}else if(up){srcPath.splice(i,1);up--;}}
if(!mustEndAbs&&!removeAllDots){for(;up--;up){srcPath.unshift('..');}}
if(mustEndAbs&&srcPath[0]!==''&&(!srcPath[0]||srcPath[0].charAt(0)!=='/')){srcPath.unshift('');}
if(hasTrailingSlash&&(srcPath.join('/').substr(-1)!=='/')){srcPath.push('');}
var isAbsolute=srcPath[0]===''||(srcPath[0]&&srcPath[0].charAt(0)==='/');if(psychotic){result.hostname=result.host=isAbsolute?'':srcPath.length?srcPath.shift():'';var authInHost=result.host&&result.host.indexOf('@')>0?result.host.split('@'):false;if(authInHost){result.auth=authInHost.shift();result.host=result.hostname=authInHost.shift();}}
mustEndAbs=mustEndAbs||(result.host&&srcPath.length);if(mustEndAbs&&!isAbsolute){srcPath.unshift('');}
if(!srcPath.length){result.pathname=null;result.path=null;}else{result.pathname=srcPath.join('/');}
if(!util.isNull(result.pathname)||!util.isNull(result.search)){result.path=(result.pathname?result.pathname:'')+
(result.search?result.search:'');}
result.auth=relative.auth||result.auth;result.slashes=result.slashes||relative.slashes;result.href=result.format();return result;};Url.prototype.parseHost=function(){var host=this.host;var port=portPattern.exec(host);if(port){port=port[0];if(port!==':'){this.port=port.substr(1);}
host=host.substr(0,host.length-port.length);}
if(host)this.hostname=host;};},{"./util":9,"punycode":4,"querystring":7}],9:[function(_dereq_,module,exports){'use strict';module.exports={isString:function(arg){return typeof(arg)==='string';},isObject:function(arg){return typeof(arg)==='object'&&arg!==null;},isNull:function(arg){return arg===null;},isNullOrUndefined:function(arg){return arg==null;}};},{}],10:[function(_dereq_,module,exports){var C=_dereq_('./constants/constants'),MS=_dereq_('./constants/merge-strategies'),Emitter=_dereq_('component-emitter'),Connection=_dereq_('./message/connection'),EventHandler=_dereq_('./event/event-handler'),RpcHandler=_dereq_('./rpc/rpc-handler'),RecordHandler=_dereq_('./record/record-handler'),PresenceHandler=_dereq_('./presence/presence-handler'),defaultOptions=_dereq_('./default-options'),messageBuilder=_dereq_('./message/message-builder');var Client=function(url,options){this._url=url;this._options=this._getOptions(options||{});this._connection=new Connection(this,this._url,this._options);this.event=new EventHandler(this._options,this._connection,this);this.rpc=new RpcHandler(this._options,this._connection,this);this.record=new RecordHandler(this._options,this._connection,this);this.presence=new PresenceHandler(this._options,this._connection,this);this._messageCallbacks={};this._messageCallbacks[C.TOPIC.EVENT]=this.event._$handle.bind(this.event);this._messageCallbacks[C.TOPIC.RPC]=this.rpc._$handle.bind(this.rpc);this._messageCallbacks[C.TOPIC.RECORD]=this.record._$handle.bind(this.record);this._messageCallbacks[C.TOPIC.PRESENCE]=this.presence._$handle.bind(this.presence);this._messageCallbacks[C.TOPIC.ERROR]=this._onErrorMessage.bind(this);};Emitter(Client.prototype);Client.prototype.login=function(authParams,callback){this._connection.authenticate(authParams||{},callback);return this;};Client.prototype.close=function(){this._connection.close();};Client.prototype.getConnectionState=function(){return this._connection.getState();};Client.prototype.getUid=function(){var timestamp=(new Date()).getTime().toString(36),randomString=(Math.random()*10000000000000000).toString(36).replace('.','');return timestamp+'-'+randomString;};Client.prototype._$onMessage=function(message){if(this._messageCallbacks[message.topic]){this._messageCallbacks[message.topic](message);}else{message.processedError=true;this._$onError(message.topic,C.EVENT.MESSAGE_PARSE_ERROR,'Received message for unknown topic '+message.topic);}
if(message.action===C.ACTIONS.ERROR&&!message.processedError){this._$onError(message.topic,message.data[0],message.data.slice(0));}};Client.prototype._$onError=function(topic,event,msg){var errorMsg;if(event===C.EVENT.ACK_TIMEOUT||event===C.EVENT.RESPONSE_TIMEOUT){if(this.getConnectionState()===C.CONNECTION_STATE.AWAITING_AUTHENTICATION){errorMsg='Your message timed out because you\'re not authenticated. Have you called login()?';setTimeout(this._$onError.bind(this,C.EVENT.NOT_AUTHENTICATED,C.TOPIC.ERROR,errorMsg),1);}}
if(this.hasListeners('error')){this.emit('error',msg,event,topic);this.emit(event,topic,msg);}else{console.log('--- You can catch all deepstream errors by subscribing to the error event ---');errorMsg=event+': '+msg;if(topic){errorMsg+=' ('+topic+')';}
throw new Error(errorMsg);}};Client.prototype._onErrorMessage=function(errorMessage){this._$onError(errorMessage.topic,errorMessage.data[0],errorMessage.data[1]);};Client.prototype._getOptions=function(options){var mergedOptions={},key;for(key in defaultOptions){if(typeof options[key]==='undefined'){mergedOptions[key]=defaultOptions[key];}else{mergedOptions[key]=options[key];}}
return mergedOptions;};function createDeepstream(url,options){return new Client(url,options);}
Client.prototype.CONSTANTS=C;createDeepstream.CONSTANTS=C;Client.prototype.MERGE_STRATEGIES=MS;createDeepstream.MERGE_STRATEGIES=MS;module.exports=createDeepstream;},{"./constants/constants":11,"./constants/merge-strategies":12,"./default-options":13,"./event/event-handler":14,"./message/connection":15,"./message/message-builder":16,"./presence/presence-handler":18,"./record/record-handler":22,"./rpc/rpc-handler":24,"component-emitter":2}],11:[function(_dereq_,module,exports){exports.CONNECTION_STATE={};exports.CONNECTION_STATE.CLOSED='CLOSED';exports.CONNECTION_STATE.AWAITING_CONNECTION='AWAITING_CONNECTION';exports.CONNECTION_STATE.CHALLENGING='CHALLENGING';exports.CONNECTION_STATE.AWAITING_AUTHENTICATION='AWAITING_AUTHENTICATION';exports.CONNECTION_STATE.AUTHENTICATING='AUTHENTICATING';exports.CONNECTION_STATE.OPEN='OPEN';exports.CONNECTION_STATE.ERROR='ERROR';exports.CONNECTION_STATE.RECONNECTING='RECONNECTING';exports.MESSAGE_SEPERATOR=String.fromCharCode(30);exports.MESSAGE_PART_SEPERATOR=String.fromCharCode(31);exports.TYPES={};exports.TYPES.STRING='S';exports.TYPES.OBJECT='O';exports.TYPES.NUMBER='N';exports.TYPES.NULL='L';exports.TYPES.TRUE='T';exports.TYPES.FALSE='F';exports.TYPES.UNDEFINED='U';exports.TOPIC={};exports.TOPIC.CONNECTION='C';exports.TOPIC.AUTH='A';exports.TOPIC.ERROR='X';exports.TOPIC.EVENT='E';exports.TOPIC.RECORD='R';exports.TOPIC.RPC='P';exports.TOPIC.PRESENCE='U';exports.TOPIC.PRIVATE='PRIVATE/';exports.EVENT={};exports.EVENT.CONNECTION_ERROR='connectionError';exports.EVENT.CONNECTION_STATE_CHANGED='connectionStateChanged';exports.EVENT.MAX_RECONNECTION_ATTEMPTS_REACHED='MAX_RECONNECTION_ATTEMPTS_REACHED';exports.EVENT.CONNECTION_AUTHENTICATION_TIMEOUT='CONNECTION_AUTHENTICATION_TIMEOUT';exports.EVENT.ACK_TIMEOUT='ACK_TIMEOUT';exports.EVENT.NO_RPC_PROVIDER='NO_RPC_PROVIDER';exports.EVENT.RESPONSE_TIMEOUT='RESPONSE_TIMEOUT';exports.EVENT.DELETE_TIMEOUT='DELETE_TIMEOUT';exports.EVENT.UNSOLICITED_MESSAGE='UNSOLICITED_MESSAGE';exports.EVENT.MESSAGE_DENIED='MESSAGE_DENIED';exports.EVENT.MESSAGE_PARSE_ERROR='MESSAGE_PARSE_ERROR';exports.EVENT.VERSION_EXISTS='VERSION_EXISTS';exports.EVENT.NOT_AUTHENTICATED='NOT_AUTHENTICATED';exports.EVENT.MESSAGE_PERMISSION_ERROR='MESSAGE_PERMISSION_ERROR';exports.EVENT.LISTENER_EXISTS='LISTENER_EXISTS';exports.EVENT.NOT_LISTENING='NOT_LISTENING';exports.EVENT.TOO_MANY_AUTH_ATTEMPTS='TOO_MANY_AUTH_ATTEMPTS';exports.EVENT.IS_CLOSED='IS_CLOSED';exports.EVENT.RECORD_NOT_FOUND='RECORD_NOT_FOUND';exports.EVENT.NOT_SUBSCRIBED='NOT_SUBSCRIBED';exports.ACTIONS={};exports.ACTIONS.PING='PI';exports.ACTIONS.PONG='PO';exports.ACTIONS.ACK='A';exports.ACTIONS.REDIRECT='RED';exports.ACTIONS.CHALLENGE='CH';exports.ACTIONS.CHALLENGE_RESPONSE='CHR';exports.ACTIONS.READ='R';exports.ACTIONS.CREATE='C';exports.ACTIONS.UPDATE='U';exports.ACTIONS.PATCH='P';exports.ACTIONS.DELETE='D';exports.ACTIONS.SUBSCRIBE='S';exports.ACTIONS.UNSUBSCRIBE='US';exports.ACTIONS.HAS='H';exports.ACTIONS.SNAPSHOT='SN';exports.ACTIONS.INVOKE='I';exports.ACTIONS.SUBSCRIPTION_FOR_PATTERN_FOUND='SP';exports.ACTIONS.SUBSCRIPTION_FOR_PATTERN_REMOVED='SR';exports.ACTIONS.SUBSCRIPTION_HAS_PROVIDER='SH';exports.ACTIONS.LISTEN='L';exports.ACTIONS.UNLISTEN='UL';exports.ACTIONS.LISTEN_ACCEPT='LA';exports.ACTIONS.LISTEN_REJECT='LR';exports.ACTIONS.PROVIDER_UPDATE='PU';exports.ACTIONS.QUERY='Q';exports.ACTIONS.CREATEORREAD='CR';exports.ACTIONS.EVENT='EVT';exports.ACTIONS.ERROR='E';exports.ACTIONS.REQUEST='REQ';exports.ACTIONS.RESPONSE='RES';exports.ACTIONS.REJECTION='REJ';exports.ACTIONS.PRESENCE_JOIN='PNJ';exports.ACTIONS.PRESENCE_LEAVE='PNL';exports.ACTIONS.QUERY='Q';exports.ACTIONS.WRITE_ACKNOWLEDGEMENT='WA';exports.CALL_STATE={};exports.CALL_STATE.INITIAL='INITIAL';exports.CALL_STATE.CONNECTING='CONNECTING';exports.CALL_STATE.ESTABLISHED='ESTABLISHED';exports.CALL_STATE.ACCEPTED='ACCEPTED';exports.CALL_STATE.DECLINED='DECLINED';exports.CALL_STATE.ENDED='ENDED';exports.CALL_STATE.ERROR='ERROR';},{}],12:[function(_dereq_,module,exports){module.exports={REMOTE_WINS:function(record,remoteValue,remoteVersion,callback){callback(null,remoteValue);},LOCAL_WINS:function(record,remoteValue,remoteVersion,callback){callback(null,record.get());}};},{}],13:[function(_dereq_,module,exports){var MERGE_STRATEGIES=_dereq_('./constants/merge-strategies');module.exports={heartbeatInterval:30000,recordPersistDefault:true,reconnectIntervalIncrement:4000,maxReconnectInterval:180000,maxReconnectAttempts:5,rpcAckTimeout:6000,rpcResponseTimeout:10000,subscriptionTimeout:2000,maxMessagesPerPacket:100,timeBetweenSendingQueuedPackages:16,recordReadAckTimeout:1000,recordReadTimeout:3000,recordDeleteTimeout:3000,path:'/deepstream',mergeStrategy:MERGE_STRATEGIES.REMOTE_WINS,recordDeepCopy:true,nodeSocketOptions:null};},{"./constants/merge-strategies":12}],14:[function(_dereq_,module,exports){var messageBuilder=_dereq_('../message/message-builder'),messageParser=_dereq_('../message/message-parser'),AckTimeoutRegistry=_dereq_('../utils/ack-timeout-registry'),ResubscribeNotifier=_dereq_('../utils/resubscribe-notifier'),C=_dereq_('../constants/constants'),Listener=_dereq_('../utils/listener'),EventEmitter=_dereq_('component-emitter');var EventHandler=function(options,connection,client){this._options=options;this._connection=connection;this._client=client;this._emitter=new EventEmitter();this._listener={};this._ackTimeoutRegistry=new AckTimeoutRegistry(client,C.TOPIC.EVENT,this._options.subscriptionTimeout);this._resubscribeNotifier=new ResubscribeNotifier(this._client,this._resubscribe.bind(this));};EventHandler.prototype.subscribe=function(name,callback){if(typeof name!=='string'||name.length===0){throw new Error('invalid argument name');}
if(typeof callback!=='function'){throw new Error('invalid argument callback');}
if(!this._emitter.hasListeners(name)){this._ackTimeoutRegistry.add(name,C.ACTIONS.SUBSCRIBE);this._connection.sendMsg(C.TOPIC.EVENT,C.ACTIONS.SUBSCRIBE,[name]);}
this._emitter.on(name,callback);};EventHandler.prototype.unsubscribe=function(name,callback){if(typeof name!=='string'||name.length===0){throw new Error('invalid argument name');}
if(callback!==undefined&&typeof callback!=='function'){throw new Error('invalid argument callback');}
this._emitter.off(name,callback);if(!this._emitter.hasListeners(name)){this._ackTimeoutRegistry.add(name,C.ACTIONS.UNSUBSCRIBE);this._connection.sendMsg(C.TOPIC.EVENT,C.ACTIONS.UNSUBSCRIBE,[name]);}};EventHandler.prototype.emit=function(name,data){if(typeof name!=='string'||name.length===0){throw new Error('invalid argument name');}
this._connection.sendMsg(C.TOPIC.EVENT,C.ACTIONS.EVENT,[name,messageBuilder.typed(data)]);this._emitter.emit(name,data);};EventHandler.prototype.listen=function(pattern,callback){if(typeof pattern!=='string'||pattern.length===0){throw new Error('invalid argument pattern');}
if(typeof callback!=='function'){throw new Error('invalid argument callback');}
if(this._listener[pattern]&&!this._listener[pattern].destroyPending){return this._client._$onError(C.TOPIC.EVENT,C.EVENT.LISTENER_EXISTS,pattern);}else if(this._listener[pattern]){this._listener[pattern].destroy();}
this._listener[pattern]=new Listener(C.TOPIC.EVENT,pattern,callback,this._options,this._client,this._connection);};EventHandler.prototype.unlisten=function(pattern){if(typeof pattern!=='string'||pattern.length===0){throw new Error('invalid argument pattern');}
var listener=this._listener[pattern];if(listener&&!listener.destroyPending){listener.sendDestroy();}else if(this._listener[pattern]){this._ackTimeoutRegistry.add(pattern,C.EVENT.UNLISTEN);this._listener[pattern].destroy();delete this._listener[pattern];}else{this._client._$onError(C.TOPIC.RECORD,C.EVENT.NOT_LISTENING,pattern);}};EventHandler.prototype._$handle=function(message){var name=message.data[message.action===C.ACTIONS.ACK?1:0];if(message.action===C.ACTIONS.EVENT){processed=true;if(message.data&&message.data.length===2){this._emitter.emit(name,messageParser.convertTyped(message.data[1],this._client));}else{this._emitter.emit(name);}
return;}
if(message.action===C.ACTIONS.ACK&&message.data[0]===C.ACTIONS.UNLISTEN&&this._listener[name]&&this._listener[name].destroyPending){this._listener[name].destroy();delete this._listener[name];return;}else if(this._listener[name]){processed=true;this._listener[name]._$onMessage(message);return;}else if(message.action===C.ACTIONS.SUBSCRIPTION_FOR_PATTERN_REMOVED){return;}else if(message.action===C.ACTIONS.SUBSCRIPTION_HAS_PROVIDER){return;}
if(message.action===C.ACTIONS.ACK){this._ackTimeoutRegistry.clear(message);return;}
if(message.action===C.ACTIONS.ERROR){if(message.data[0]===C.EVENT.MESSAGE_DENIED){this._ackTimeoutRegistry.remove(message.data[1],message.data[2]);}
else if(message.data[0]===C.EVENT.NOT_SUBSCRIBED){this._ackTimeoutRegistry.remove(message.data[1],C.ACTIONS.UNSUBSCRIBE);}
message.processedError=true;this._client._$onError(C.TOPIC.EVENT,message.data[0],message.data[1]);return;}
this._client._$onError(C.TOPIC.EVENT,C.EVENT.UNSOLICITED_MESSAGE,name);};EventHandler.prototype._resubscribe=function(){var callbacks=this._emitter._callbacks;for(var eventName in callbacks){this._connection.sendMsg(C.TOPIC.EVENT,C.ACTIONS.SUBSCRIBE,[eventName]);}};module.exports=EventHandler;},{"../constants/constants":11,"../message/message-builder":16,"../message/message-parser":17,"../utils/ack-timeout-registry":27,"../utils/listener":28,"../utils/resubscribe-notifier":29,"component-emitter":2}],15:[function(_dereq_,module,exports){(function(global){var BrowserWebSocket=global.WebSocket||global.MozWebSocket,NodeWebSocket=_dereq_('ws'),messageParser=_dereq_('./message-parser'),messageBuilder=_dereq_('./message-builder'),utils=_dereq_('../utils/utils'),C=_dereq_('../constants/constants');var Connection=function(client,url,options){this._client=client;this._options=options;this._authParams=null;this._authCallback=null;this._deliberateClose=false;this._redirecting=false;this._tooManyAuthAttempts=false;this._connectionAuthenticationTimeout=false;this._challengeDenied=false;this._queuedMessages=[];this._reconnectTimeout=null;this._reconnectionAttempt=0;this._currentPacketMessageCount=0;this._sendNextPacketTimeout=null;this._currentMessageResetTimeout=null;this._endpoint=null;this._lastHeartBeat=null;this._heartbeatInterval=null;this._originalUrl=utils.parseUrl(url,this._options.path);this._url=this._originalUrl;this._state=C.CONNECTION_STATE.CLOSED;this._createEndpoint();};Connection.prototype.getState=function(){return this._state;};Connection.prototype.authenticate=function(authParams,callback){this._authParams=authParams;this._authCallback=callback;if(this._tooManyAuthAttempts||this._challengeDenied||this._connectionAuthenticationTimeout){this._client._$onError(C.TOPIC.ERROR,C.EVENT.IS_CLOSED,'this client\'s connection was closed');return;}
else if(this._deliberateClose===true&&this._state===C.CONNECTION_STATE.CLOSED){this._createEndpoint();this._deliberateClose=false;return;}
if(this._state===C.CONNECTION_STATE.AWAITING_AUTHENTICATION){this._sendAuthParams();}};Connection.prototype.sendMsg=function(topic,action,data){this.send(messageBuilder.getMsg(topic,action,data));};Connection.prototype.send=function(message){this._queuedMessages.push(message);this._currentPacketMessageCount++;if(this._currentMessageResetTimeout===null){this._currentMessageResetTimeout=utils.nextTick(this._resetCurrentMessageCount.bind(this));}
if(this._state===C.CONNECTION_STATE.OPEN&&this._queuedMessages.length<this._options.maxMessagesPerPacket&&this._currentPacketMessageCount<this._options.maxMessagesPerPacket){this._sendQueuedMessages();}
else if(this._sendNextPacketTimeout===null){this._queueNextPacket();}};Connection.prototype.close=function(){clearInterval(this._heartbeatInterval);this._deliberateClose=true;this._endpoint.close();};Connection.prototype._createEndpoint=function(){this._endpoint=BrowserWebSocket?new BrowserWebSocket(this._url):new NodeWebSocket(this._url,this._options.nodeSocketOptions);this._endpoint.onopen=this._onOpen.bind(this);this._endpoint.onerror=this._onError.bind(this);this._endpoint.onclose=this._onClose.bind(this);this._endpoint.onmessage=this._onMessage.bind(this);};Connection.prototype._resetCurrentMessageCount=function(){this._currentPacketMessageCount=0;this._currentMessageResetTimeout=null;};Connection.prototype._sendQueuedMessages=function(){if(this._state!==C.CONNECTION_STATE.OPEN||this._endpoint.readyState!==this._endpoint.OPEN){return;}
if(this._queuedMessages.length===0){this._sendNextPacketTimeout=null;return;}
var message=this._queuedMessages.splice(0,this._options.maxMessagesPerPacket).join('');if(this._queuedMessages.length!==0){this._queueNextPacket();}else{this._sendNextPacketTimeout=null;}
this._submit(message);};Connection.prototype._submit=function(message){if(this._endpoint.readyState===this._endpoint.OPEN){this._endpoint.send(message);}else{this._onError('Tried to send message on a closed websocket connection');}}
Connection.prototype._queueNextPacket=function(){var fn=this._sendQueuedMessages.bind(this),delay=this._options.timeBetweenSendingQueuedPackages;this._sendNextPacketTimeout=setTimeout(fn,delay);};Connection.prototype._sendAuthParams=function(){this._setState(C.CONNECTION_STATE.AUTHENTICATING);var authMessage=messageBuilder.getMsg(C.TOPIC.AUTH,C.ACTIONS.REQUEST,[this._authParams]);this._submit(authMessage);};Connection.prototype._checkHeartBeat=function(){var heartBeatTolerance=this._options.heartbeatInterval*2;if(Date.now()-this._lastHeartBeat>heartBeatTolerance){clearInterval(this._heartbeatInterval);this._endpoint.close();this._onError('Two connections heartbeats missed successively');}};Connection.prototype._onOpen=function(){this._clearReconnect();this._lastHeartBeat=Date.now();this._heartbeatInterval=utils.setInterval(this._checkHeartBeat.bind(this),this._options.heartbeatInterval);this._setState(C.CONNECTION_STATE.AWAITING_CONNECTION);};Connection.prototype._onError=function(error){clearInterval(this._heartbeatInterval);this._setState(C.CONNECTION_STATE.ERROR);setTimeout(function(){var msg;if(error.code==='ECONNRESET'||error.code==='ECONNREFUSED'){msg='Can\'t connect! Deepstream server unreachable on '+this._originalUrl;}else{msg=error.toString();}
this._client._$onError(C.TOPIC.CONNECTION,C.EVENT.CONNECTION_ERROR,msg);}.bind(this),1);};Connection.prototype._onClose=function(){clearInterval(this._heartbeatInterval);if(this._redirecting===true){this._redirecting=false;this._createEndpoint();}
else if(this._deliberateClose===true){this._setState(C.CONNECTION_STATE.CLOSED);}
else{this._tryReconnect();}};Connection.prototype._onMessage=function(message){var parsedMessages=messageParser.parse(message.data,this._client),i;for(i=0;i<parsedMessages.length;i++){if(parsedMessages[i]===null){continue;}
else if(parsedMessages[i].topic===C.TOPIC.CONNECTION){this._handleConnectionResponse(parsedMessages[i]);}
else if(parsedMessages[i].topic===C.TOPIC.AUTH){this._handleAuthResponse(parsedMessages[i]);}else{this._client._$onMessage(parsedMessages[i]);}}};Connection.prototype._handleConnectionResponse=function(message){var data;if(message.action===C.ACTIONS.PING){this._lastHeartBeat=Date.now();this._submit(messageBuilder.getMsg(C.TOPIC.CONNECTION,C.ACTIONS.PONG));}
else if(message.action===C.ACTIONS.ACK){this._setState(C.CONNECTION_STATE.AWAITING_AUTHENTICATION);if(this._authParams){this._sendAuthParams();}}
else if(message.action===C.ACTIONS.CHALLENGE){this._setState(C.CONNECTION_STATE.CHALLENGING);this._submit(messageBuilder.getMsg(C.TOPIC.CONNECTION,C.ACTIONS.CHALLENGE_RESPONSE,[this._originalUrl]));}
else if(message.action===C.ACTIONS.REJECTION){this._challengeDenied=true;this.close();}
else if(message.action===C.ACTIONS.REDIRECT){this._url=message.data[0];this._redirecting=true;this._endpoint.close();}
else if(message.action===C.ACTIONS.ERROR){if(message.data[0]===C.EVENT.CONNECTION_AUTHENTICATION_TIMEOUT){this._deliberateClose=true;this._connectionAuthenticationTimeout=true;this._client._$onError(C.TOPIC.CONNECTION,message.data[0],message.data[1]);}}};Connection.prototype._handleAuthResponse=function(message){var data;if(message.action===C.ACTIONS.ERROR){if(message.data[0]===C.EVENT.TOO_MANY_AUTH_ATTEMPTS){this._deliberateClose=true;this._tooManyAuthAttempts=true;}else{this._setState(C.CONNECTION_STATE.AWAITING_AUTHENTICATION);}
if(this._authCallback){this._authCallback(false,this._getAuthData(message.data[1]));}}else if(message.action===C.ACTIONS.ACK){this._setState(C.CONNECTION_STATE.OPEN);if(this._authCallback){this._authCallback(true,this._getAuthData(message.data[0]));}
this._sendQueuedMessages();}};Connection.prototype._getAuthData=function(data){if(data===undefined){return null;}else{return messageParser.convertTyped(data,this._client);}};Connection.prototype._setState=function(state){this._state=state;this._client.emit(C.EVENT.CONNECTION_STATE_CHANGED,state);};Connection.prototype._tryReconnect=function(){if(this._reconnectTimeout!==null){return;}
if(this._reconnectionAttempt<this._options.maxReconnectAttempts){this._setState(C.CONNECTION_STATE.RECONNECTING);this._reconnectTimeout=setTimeout(this._tryOpen.bind(this),Math.min(this._options.maxReconnectInterval,this._options.reconnectIntervalIncrement*this._reconnectionAttempt));this._reconnectionAttempt++;}else{this._clearReconnect();this.close();this._client.emit(C.MAX_RECONNECTION_ATTEMPTS_REACHED,this._reconnectionAttempt);}};Connection.prototype._tryOpen=function(){if(this._originalUrl!==this._url){this._url=this._originalUrl;}
this._createEndpoint();this._reconnectTimeout=null;};Connection.prototype._clearReconnect=function(){clearTimeout(this._reconnectTimeout);this._reconnectTimeout=null;this._reconnectionAttempt=0;};module.exports=Connection;}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"../constants/constants":11,"../utils/utils":31,"./message-builder":16,"./message-parser":17,"ws":1}],16:[function(_dereq_,module,exports){var C=_dereq_('../constants/constants'),SEP=C.MESSAGE_PART_SEPERATOR;exports.getMsg=function(topic,action,data){if(data&&!(data instanceof Array)){throw new Error('data must be an array');}
var sendData=[topic,action],i;if(data){for(i=0;i<data.length;i++){if(typeof data[i]==='object'){sendData.push(JSON.stringify(data[i]));}else{sendData.push(data[i]);}}}
return sendData.join(SEP)+C.MESSAGE_SEPERATOR;};exports.typed=function(value){var type=typeof value;if(type==='string'){return C.TYPES.STRING+value;}
if(value===null){return C.TYPES.NULL;}
if(type==='object'){return C.TYPES.OBJECT+JSON.stringify(value);}
if(type==='number'){return C.TYPES.NUMBER+value.toString();}
if(value===true){return C.TYPES.TRUE;}
if(value===false){return C.TYPES.FALSE;}
if(value===undefined){return C.TYPES.UNDEFINED;}
throw new Error('Can\'t serialize type '+value);};},{"../constants/constants":11}],17:[function(_dereq_,module,exports){var C=_dereq_('../constants/constants');var MessageParser=function(){this._actions=this._getActions();};MessageParser.prototype.parse=function(message,client){var parsedMessages=[],rawMessages=message.split(C.MESSAGE_SEPERATOR),i;for(i=0;i<rawMessages.length;i++){if(rawMessages[i].length>2){parsedMessages.push(this._parseMessage(rawMessages[i],client));}}
return parsedMessages;};MessageParser.prototype.convertTyped=function(value,client){var type=value.charAt(0);if(type===C.TYPES.STRING){return value.substr(1);}
if(type===C.TYPES.OBJECT){try{return JSON.parse(value.substr(1));}catch(e){client._$onError(C.TOPIC.ERROR,C.EVENT.MESSAGE_PARSE_ERROR,e.toString()+'('+value+')');return;}}
if(type===C.TYPES.NUMBER){return parseFloat(value.substr(1));}
if(type===C.TYPES.NULL){return null;}
if(type===C.TYPES.TRUE){return true;}
if(type===C.TYPES.FALSE){return false;}
if(type===C.TYPES.UNDEFINED){return undefined;}
client._$onError(C.TOPIC.ERROR,C.EVENT.MESSAGE_PARSE_ERROR,'UNKNOWN_TYPE ('+value+')');};MessageParser.prototype._getActions=function(){var actions={},key;for(key in C.ACTIONS){actions[C.ACTIONS[key]]=key;}
return actions;};MessageParser.prototype._parseMessage=function(message,client){var parts=message.split(C.MESSAGE_PART_SEPERATOR),messageObject={};if(parts.length<2){message.processedError=true;client._$onError(C.TOPIC.ERROR,C.EVENT.MESSAGE_PARSE_ERROR,'Insufficiant message parts');return null;}
if(this._actions[parts[1]]===undefined){message.processedError=true;client._$onError(C.TOPIC.ERROR,C.EVENT.MESSAGE_PARSE_ERROR,'Unknown action '+parts[1]);return null;}
messageObject.raw=message;messageObject.topic=parts[0];messageObject.action=parts[1];messageObject.data=parts.splice(2);return messageObject;};module.exports=new MessageParser();},{"../constants/constants":11}],18:[function(_dereq_,module,exports){var EventEmitter=_dereq_('component-emitter'),C=_dereq_('../constants/constants'),AckTimeoutRegistry=_dereq_('../utils/ack-timeout-registry'),messageParser=_dereq_('../message/message-parser'),messageBuilder=_dereq_('../message/message-builder'),ResubscribeNotifier=_dereq_('../utils/resubscribe-notifier');var PresenceHandler=function(options,connection,client){this._options=options;this._connection=connection;this._client=client;this._emitter=new EventEmitter();this._ackTimeoutRegistry=new AckTimeoutRegistry(client,C.TOPIC.PRESENCE,this._options.subscriptionTimeout);this._resubscribeNotifier=new ResubscribeNotifier(this._client,this._resubscribe.bind(this));};PresenceHandler.prototype.getAll=function(callback){if(!this._emitter.hasListeners(C.ACTIONS.QUERY)){this._connection.sendMsg(C.TOPIC.PRESENCE,C.ACTIONS.QUERY,[C.ACTIONS.QUERY]);}
this._emitter.once(C.ACTIONS.QUERY,callback);};PresenceHandler.prototype.subscribe=function(callback){if(callback!==undefined&&typeof callback!=='function'){throw new Error('invalid argument callback');}
if(!this._emitter.hasListeners(C.TOPIC.PRESENCE)){this._ackTimeoutRegistry.add(C.TOPIC.PRESENCE,C.ACTIONS.SUBSCRIBE);this._connection.sendMsg(C.TOPIC.PRESENCE,C.ACTIONS.SUBSCRIBE,[C.ACTIONS.SUBSCRIBE]);}
this._emitter.on(C.TOPIC.PRESENCE,callback);};PresenceHandler.prototype.unsubscribe=function(callback){if(callback!==undefined&&typeof callback!=='function'){throw new Error('invalid argument callback');}
this._emitter.off(C.TOPIC.PRESENCE,callback);if(!this._emitter.hasListeners(C.TOPIC.PRESENCE)){this._ackTimeoutRegistry.add(C.TOPIC.PRESENCE,C.ACTIONS.UNSUBSCRIBE);this._connection.sendMsg(C.TOPIC.PRESENCE,C.ACTIONS.UNSUBSCRIBE,[C.ACTIONS.UNSUBSCRIBE]);}};PresenceHandler.prototype._$handle=function(message){if(message.action===C.ACTIONS.ERROR&&message.data[0]===C.EVENT.MESSAGE_DENIED){this._ackTimeoutRegistry.remove(C.TOPIC.PRESENCE,message.data[1]);message.processedError=true;this._client._$onError(C.TOPIC.PRESENCE,C.EVENT.MESSAGE_DENIED,message.data[1]);}
else if(message.action===C.ACTIONS.ACK){this._ackTimeoutRegistry.clear(message);}
else if(message.action===C.ACTIONS.PRESENCE_JOIN){this._emitter.emit(C.TOPIC.PRESENCE,message.data[0],true);}
else if(message.action===C.ACTIONS.PRESENCE_LEAVE){this._emitter.emit(C.TOPIC.PRESENCE,message.data[0],false);}
else if(message.action===C.ACTIONS.QUERY){this._emitter.emit(C.ACTIONS.QUERY,message.data);}
else{this._client._$onError(C.TOPIC.PRESENCE,C.EVENT.UNSOLICITED_MESSAGE,message.action);}};PresenceHandler.prototype._resubscribe=function(){var callbacks=this._emitter._callbacks;if(callbacks&&callbacks[C.TOPIC.PRESENCE]){this._connection.sendMsg(C.TOPIC.PRESENCE,C.ACTIONS.SUBSCRIBE,[C.ACTIONS.SUBSCRIBE]);}};module.exports=PresenceHandler;},{"../constants/constants":11,"../message/message-builder":16,"../message/message-parser":17,"../utils/ack-timeout-registry":27,"../utils/resubscribe-notifier":29,"component-emitter":2}],19:[function(_dereq_,module,exports){var Record=_dereq_('./record'),EventEmitter=_dereq_('component-emitter');var AnonymousRecord=function(recordHandler){this.name=null;this._recordHandler=recordHandler;this._record=null;this._subscriptions=[];this._proxyMethod('delete');this._proxyMethod('set');this._proxyMethod('discard');};EventEmitter(AnonymousRecord.prototype);AnonymousRecord.prototype.get=function(path){if(this._record===null){return undefined;}
return this._record.get(path);};AnonymousRecord.prototype.subscribe=function(){var parameters=Record.prototype._normalizeArguments(arguments);parameters.triggerNow=true;this._subscriptions.push(parameters);if(this._record!==null){this._record.subscribe(parameters);}};AnonymousRecord.prototype.unsubscribe=function(){var parameters=Record.prototype._normalizeArguments(arguments),subscriptions=[],i;for(i=0;i<this._subscriptions.length;i++){if(this._subscriptions[i].path!==parameters.path||this._subscriptions[i].callback!==parameters.callback){subscriptions.push(this._subscriptions[i]);}}
this._subscriptions=subscriptions;if(this._record!==null){this._record.unsubscribe(parameters);}};AnonymousRecord.prototype.setName=function(recordName){this.name=recordName;var i;if(this._record!==null&&!this._record.isDestroyed){for(i=0;i<this._subscriptions.length;i++){this._record.unsubscribe(this._subscriptions[i]);}
this._record.discard();}
this._record=this._recordHandler.getRecord(recordName);for(i=0;i<this._subscriptions.length;i++){this._record.subscribe(this._subscriptions[i]);}
this._record.whenReady(this.emit.bind(this,'ready'));this.emit('nameChanged',recordName);};AnonymousRecord.prototype._proxyMethod=function(methodName){this[methodName]=this._callMethodOnRecord.bind(this,methodName);};AnonymousRecord.prototype._callMethodOnRecord=function(methodName){if(this._record===null){throw new Error('Can`t invoke '+methodName+'. AnonymousRecord not initialised. Call setName first');}
if(typeof this._record[methodName]!=='function'){throw new Error(methodName+' is not a method on the record');}
var args=Array.prototype.slice.call(arguments,1);return this._record[methodName].apply(this._record,args);};module.exports=AnonymousRecord;},{"./record":23,"component-emitter":2}],20:[function(_dereq_,module,exports){var utils=_dereq_('../utils/utils');var PARTS_REG_EXP=/([^\.\[\]\s]+)/g;var cache=Object.create(null);module.exports.get=function(data,path,deepCopy){var tokens=tokenize(path);for(var i=0;i<tokens.length;i++){if(data===undefined){return undefined;}
if(typeof data!=='object'){throw new Error('invalid data or path');}
data=data[tokens[i]];}
return deepCopy!==false?utils.deepCopy(data):data;};module.exports.set=function(data,path,value,deepCopy){var tokens=tokenize(path);if(tokens.length===0){return patch(data,value,deepCopy);}
var oldValue=module.exports.get(data,path,false);var newValue=patch(oldValue,value,deepCopy);if(newValue===oldValue){return data;}
var result=utils.shallowCopy(data);var node=result;for(var i=0;i<tokens.length;i++){if(i===tokens.length-1){node[tokens[i]]=newValue;}
else if(node[tokens[i]]!==undefined){node=node[tokens[i]]=utils.shallowCopy(node[tokens[i]]);}
else if(tokens[i+1]&&!isNaN(tokens[i+1])){node=node[tokens[i]]=[];}
else{node=node[tokens[i]]=Object.create(null);}}
return result;};function patch(oldValue,newValue,deepCopy){var i;if(utils.deepEquals(oldValue,newValue)){return oldValue;}
else if(oldValue===null||newValue===null){return newValue;}
else if(Array.isArray(oldValue)&&Array.isArray(newValue)){var arr=[];for(i=0;i<newValue.length;i++){arr[i]=patch(oldValue[i],newValue[i],deepCopy);}
return arr;}
else if(!Array.isArray(newValue)&&typeof oldValue==='object'&&typeof newValue==='object'){var props=Object.keys(newValue);var obj=Object.create(null);for(i=0;i<props.length;i++){obj[props[i]]=patch(oldValue[props[i]],newValue[props[i]],deepCopy);}
return obj;}
else{return deepCopy!==false?utils.deepCopy(newValue):newValue;}}
function tokenize(path){if(cache[path]){return cache[path];}
var parts=String(path)!=='undefined'?String(path).match(PARTS_REG_EXP):[];if(!parts){throw new Error('invalid path '+path)}
return cache[path]=parts.map(function(part){return!isNaN(part)?parseInt(part,10):part;});};},{"../utils/utils":31}],21:[function(_dereq_,module,exports){var EventEmitter=_dereq_('component-emitter'),Record=_dereq_('./record'),C=_dereq_('../constants/constants'),ENTRY_ADDED_EVENT='entry-added',ENTRY_REMOVED_EVENT='entry-removed',ENTRY_MOVED_EVENT='entry-moved';var List=function(recordHandler,name,options){if(typeof name!=='string'||name.length===0){throw new Error('invalid argument name');}
this._recordHandler=recordHandler;this._record=this._recordHandler.getRecord(name,options);this._record._applyUpdate=this._applyUpdate.bind(this);this._record.on('delete',this.emit.bind(this,'delete'));this._record.on('discard',this._onDiscard.bind(this));this._record.on('ready',this._onReady.bind(this));this.isDestroyed=this._record.isDestroyed;this.isReady=this._record.isReady;this.name=name;this._queuedMethods=[];this._beforeStructure=null;this._hasAddListener=null;this._hasRemoveListener=null;this._hasMoveListener=null;this.delete=this._record.delete.bind(this._record);this.discard=this._record.discard.bind(this._record);this.whenReady=this._record.whenReady.bind(this);};EventEmitter(List.prototype);List.prototype.getEntries=function(){var entries=this._record.get();if(!(entries instanceof Array)){return[];}
return entries;};List.prototype.isEmpty=function(){return this.getEntries().length===0;};List.prototype.setEntries=function(entries){var errorMsg='entries must be an array of record names',i;if(!(entries instanceof Array)){throw new Error(errorMsg);}
for(i=0;i<entries.length;i++){if(typeof entries[i]!=='string'){throw new Error(errorMsg);}}
if(this._record.isReady===false){this._queuedMethods.push(this.setEntries.bind(this,entries));}else{this._beforeChange();this._record.set(entries);this._afterChange();}};List.prototype.removeEntry=function(entry,index){if(this._record.isReady===false){this._queuedMethods.push(this.removeEntry.bind(this,entry));return;}
var currentEntries=this._record.get(),hasIndex=this._hasIndex(index),entries=[],i;for(i=0;i<currentEntries.length;i++){if(currentEntries[i]!==entry||(hasIndex&&index!==i)){entries.push(currentEntries[i]);}}
this._beforeChange();this._record.set(entries);this._afterChange();};List.prototype.addEntry=function(entry,index){if(typeof entry!=='string'){throw new Error('Entry must be a recordName');}
if(this._record.isReady===false){this._queuedMethods.push(this.addEntry.bind(this,entry));return;}
var hasIndex=this._hasIndex(index);var entries=this.getEntries();if(hasIndex){entries.splice(index,0,entry);}else{entries.push(entry);}
this._beforeChange();this._record.set(entries);this._afterChange();};List.prototype.subscribe=function(){var parameters=Record.prototype._normalizeArguments(arguments);if(parameters.path){throw new Error('path is not supported for List.subscribe');}
var listCallback=function(callback){callback(this.getEntries());}.bind(this,parameters.callback);parameters.callback.wrappedCallback=listCallback;parameters.callback=listCallback;this._record.subscribe(parameters);};List.prototype.unsubscribe=function(){var parameters=Record.prototype._normalizeArguments(arguments);if(parameters.path){throw new Error('path is not supported for List.unsubscribe');}
parameters.callback=parameters.callback.wrappedCallback;this._record.unsubscribe(parameters);};List.prototype._onReady=function(){this.isReady=true;for(var i=0;i<this._queuedMethods.length;i++){this._queuedMethods[i]();}
this.emit('ready');};List.prototype._onDiscard=function(){this.isDestroyed=true;this.emit('discard');};List.prototype._applyUpdate=function(message){if(message.action===C.ACTIONS.PATCH){throw new Error('PATCH is not supported for Lists');}
if(message.data[2].charAt(0)!=='['){message.data[2]='[]';}
this._beforeChange();Record.prototype._applyUpdate.call(this._record,message);this._afterChange();};List.prototype._hasIndex=function(index){var hasIndex=false;var entries=this.getEntries();if(index!==undefined){if(isNaN(index)){throw new Error('Index must be a number');}
if(index!==entries.length&&(index>=entries.length||index<0)){throw new Error('Index must be within current entries');}
hasIndex=true;}
return hasIndex;};List.prototype._beforeChange=function(){this._hasAddListener=this.listeners(ENTRY_ADDED_EVENT).length>0;this._hasRemoveListener=this.listeners(ENTRY_REMOVED_EVENT).length>0;this._hasMoveListener=this.listeners(ENTRY_MOVED_EVENT).length>0;if(this._hasAddListener||this._hasRemoveListener||this._hasMoveListener){this._beforeStructure=this._getStructure();}else{this._beforeStructure=null;}};List.prototype._afterChange=function(){if(this._beforeStructure===null){return;}
var after=this._getStructure();var before=this._beforeStructure;var entry,i;if(this._hasRemoveListener){for(entry in before){for(i=0;i<before[entry].length;i++){if(after[entry]===undefined||after[entry][i]===undefined){this.emit(ENTRY_REMOVED_EVENT,entry,before[entry][i]);}}}}
if(this._hasAddListener||this._hasMoveListener){for(entry in after){if(before[entry]===undefined){for(i=0;i<after[entry].length;i++){this.emit(ENTRY_ADDED_EVENT,entry,after[entry][i]);}}else{for(i=0;i<after[entry].length;i++){if(before[entry][i]!==after[entry][i]){if(before[entry][i]===undefined){this.emit(ENTRY_ADDED_EVENT,entry,after[entry][i]);}else{this.emit(ENTRY_MOVED_EVENT,entry,after[entry][i]);}}}}}}};List.prototype._getStructure=function(){var structure={};var i;var entries=this._record.get();for(i=0;i<entries.length;i++){if(structure[entries[i]]===undefined){structure[entries[i]]=[i];}else{structure[entries[i]].push(i);}}
return structure;};module.exports=List;},{"../constants/constants":11,"./record":23,"component-emitter":2}],22:[function(_dereq_,module,exports){var Record=_dereq_('./record'),AnonymousRecord=_dereq_('./anonymous-record'),List=_dereq_('./list'),Listener=_dereq_('../utils/listener'),SingleNotifier=_dereq_('../utils/single-notifier'),C=_dereq_('../constants/constants'),messageParser=_dereq_('../message/message-parser'),EventEmitter=_dereq_('component-emitter');var RecordHandler=function(options,connection,client){this._options=options;this._connection=connection;this._client=client;this._records={};this._lists={};this._listener={};this._destroyEventEmitter=new EventEmitter();this._hasRegistry=new SingleNotifier(client,connection,C.TOPIC.RECORD,C.ACTIONS.HAS,this._options.recordReadTimeout);this._snapshotRegistry=new SingleNotifier(client,connection,C.TOPIC.RECORD,C.ACTIONS.SNAPSHOT,this._options.recordReadTimeout);};RecordHandler.prototype.getRecord=function(name,recordOptions){if(!this._records[name]){this._records[name]=new Record(name,recordOptions||{},this._connection,this._options,this._client);this._records[name].on('error',this._onRecordError.bind(this,name));this._records[name].on('destroyPending',this._onDestroyPending.bind(this,name));this._records[name].on('delete',this._removeRecord.bind(this,name));this._records[name].on('discard',this._removeRecord.bind(this,name));}
this._records[name].usages++;return this._records[name];};RecordHandler.prototype.getList=function(name,options){if(!this._lists[name]){this._lists[name]=new List(this,name,options);}else{this._records[name].usages++;}
return this._lists[name];};RecordHandler.prototype.getAnonymousRecord=function(){return new AnonymousRecord(this);};RecordHandler.prototype.listen=function(pattern,callback){if(typeof pattern!=='string'||pattern.length===0){throw new Error('invalid argument pattern');}
if(typeof callback!=='function'){throw new Error('invalid argument callback');}
if(this._listener[pattern]&&!this._listener[pattern].destroyPending){return this._client._$onError(C.TOPIC.RECORD,C.EVENT.LISTENER_EXISTS,pattern);}
if(this._listener[pattern]){this._listener[pattern].destroy();}
this._listener[pattern]=new Listener(C.TOPIC.RECORD,pattern,callback,this._options,this._client,this._connection);};RecordHandler.prototype.unlisten=function(pattern){if(typeof pattern!=='string'||pattern.length===0){throw new Error('invalid argument pattern');}
var listener=this._listener[pattern];if(listener&&!listener.destroyPending){listener.sendDestroy();}else if(this._listener[pattern]){this._listener[pattern].destroy();delete this._listener[pattern];}else{this._client._$onError(C.TOPIC.RECORD,C.EVENT.NOT_LISTENING,pattern);}};RecordHandler.prototype.snapshot=function(name,callback){if(typeof name!=='string'||name.length===0){throw new Error('invalid argument name');}
if(this._records[name]&&this._records[name].isReady){callback(null,this._records[name].get());}else{this._snapshotRegistry.request(name,callback);}};RecordHandler.prototype.has=function(name,callback){if(typeof name!=='string'||name.length===0){throw new Error('invalid argument name');}
if(this._records[name]){callback(null,true);}else{this._hasRegistry.request(name,callback);}};RecordHandler.prototype._$handle=function(message){var name;if(message.action===C.ACTIONS.ERROR&&(message.data[0]!==C.EVENT.VERSION_EXISTS&&message.data[0]!==C.ACTIONS.SNAPSHOT&&message.data[0]!==C.ACTIONS.HAS&&message.data[0]!==C.EVENT.MESSAGE_DENIED)){message.processedError=true;this._client._$onError(C.TOPIC.RECORD,message.data[0],message.data[1]);return;}
if(message.action===C.ACTIONS.ACK||message.action===C.ACTIONS.ERROR){name=message.data[1];if(message.data[0]===C.ACTIONS.DELETE||message.data[0]===C.ACTIONS.UNSUBSCRIBE||(message.data[0]===C.EVENT.MESSAGE_DENIED&&message.data[2]===C.ACTIONS.DELETE)){this._destroyEventEmitter.emit('destroy_ack_'+name,message);if(message.data[0]===C.ACTIONS.DELETE&&this._records[name]){this._records[name]._$onMessage(message);}
return;}
if(message.data[0]===C.ACTIONS.SNAPSHOT){message.processedError=true;this._snapshotRegistry.recieve(name,message.data[2]);return;}
if(message.data[0]===C.ACTIONS.HAS){message.processedError=true;this._snapshotRegistry.recieve(name,message.data[2]);return;}}else{name=message.data[0];}
var processed=false;if(this._records[name]){processed=true;this._records[name]._$onMessage(message);}
if(message.action===C.ACTIONS.READ&&this._snapshotRegistry.hasRequest(name)){processed=true;this._snapshotRegistry.recieve(name,null,JSON.parse(message.data[2]));}
if(message.action===C.ACTIONS.HAS&&this._hasRegistry.hasRequest(name)){processed=true;this._hasRegistry.recieve(name,null,messageParser.convertTyped(message.data[1]));}
if(message.action===C.ACTIONS.ACK&&message.data[0]===C.ACTIONS.UNLISTEN&&this._listener[name]&&this._listener[name].destroyPending){processed=true;this._listener[name].destroy();delete this._listener[name];}else if(this._listener[name]){processed=true;this._listener[name]._$onMessage(message);}else if(message.action===C.ACTIONS.SUBSCRIPTION_FOR_PATTERN_REMOVED){processed=true;}else if(message.action===C.ACTIONS.SUBSCRIPTION_HAS_PROVIDER){processed=true;}
if(!processed){message.processedError=true;this._client._$onError(C.TOPIC.RECORD,C.EVENT.UNSOLICITED_MESSAGE,name);}};RecordHandler.prototype._onRecordError=function(recordName,error){this._client._$onError(C.TOPIC.RECORD,error,recordName);};RecordHandler.prototype._onDestroyPending=function(recordName){if(!this._records[recordName]){this.emit('error','Record \''+recordName+'\' does not exists');return;}
var onMessage=this._records[recordName]._$onMessage.bind(this._records[recordName]);this._destroyEventEmitter.once('destroy_ack_'+recordName,onMessage);this._removeRecord(recordName);};RecordHandler.prototype._removeRecord=function(recordName){delete this._records[recordName];delete this._lists[recordName];};module.exports=RecordHandler;},{"../constants/constants":11,"../message/message-parser":17,"../utils/listener":28,"../utils/single-notifier":30,"./anonymous-record":19,"./list":21,"./record":23,"component-emitter":2}],23:[function(_dereq_,module,exports){var jsonPath=_dereq_('./json-path'),utils=_dereq_('../utils/utils'),ResubscribeNotifier=_dereq_('../utils/resubscribe-notifier'),EventEmitter=_dereq_('component-emitter'),C=_dereq_('../constants/constants'),messageBuilder=_dereq_('../message/message-builder'),messageParser=_dereq_('../message/message-parser');var Record=function(name,recordOptions,connection,options,client){if(typeof name!=='string'||name.length===0){throw new Error('invalid argument name');}
this.name=name;this.usages=0;this._recordOptions=recordOptions;this._connection=connection;this._client=client;this._options=options;this.isReady=false;this.isDestroyed=false;this.hasProvider=false;this._$data=Object.create(null);this.version=null;this._eventEmitter=new EventEmitter();this._queuedMethodCalls=[];this._writeCallbacks={};this._mergeStrategy=null;if(options.mergeStrategy){this.setMergeStrategy(options.mergeStrategy);}
this._resubscribeNotifier=new ResubscribeNotifier(this._client,this._sendRead.bind(this));this._readAckTimeout=setTimeout(this._onTimeout.bind(this,C.EVENT.ACK_TIMEOUT),this._options.recordReadAckTimeout);this._readTimeout=setTimeout(this._onTimeout.bind(this,C.EVENT.RESPONSE_TIMEOUT),this._options.recordReadTimeout);this._sendRead();};EventEmitter(Record.prototype);Record.prototype.setMergeStrategy=function(mergeStrategy){if(typeof mergeStrategy==='function'){this._mergeStrategy=mergeStrategy;}else{throw new Error('Invalid merge strategy: Must be a Function');}};Record.prototype.get=function(path){return jsonPath.get(this._$data,path,this._options.recordDeepCopy);};Record.prototype.set=function(pathOrData,dataOrCallback,callback){var path,data;if(arguments.length===1){if(typeof pathOrData!=='object')
throw new Error('invalid argument data');data=pathOrData;}
else if(arguments.length===2){if((typeof pathOrData==='string'&&pathOrData.length!==0)&&typeof dataOrCallback!=='function'){path=pathOrData;data=dataOrCallback}
else if(typeof pathOrData==='object'&&typeof dataOrCallback==='function'){data=pathOrData;callback=dataOrCallback;}
else{throw new Error('invalid argument path')}}
else if(arguments.length===3){if(typeof pathOrData!=='string'||pathOrData.length===0||typeof callback!=='function'){throw new Error('invalid arguments, must pass in a string, a value and a function')}
path=pathOrData;data=dataOrCallback;}
if(this._checkDestroyed('set')){return this;}
if(!this.isReady){this._queuedMethodCalls.push({method:'set',args:arguments});return this;}
var oldValue=this._$data;var newValue=jsonPath.set(oldValue,path,data,this._options.recordDeepCopy);if(oldValue===newValue){return this;}
var config;if(callback!==undefined){config={};config.writeSuccess=true;this._setUpCallback(this.version,callback)
var connectionState=this._client.getConnectionState();if(connectionState===C.CONNECTION_STATE.CLOSED||connectionState===C.CONNECTION_STATE.RECONNECTING){callback('Connection error: error updating record as connection was closed');}}
this._sendUpdate(path,data,config);this._applyChange(newValue);return this;};Record.prototype.subscribe=function(path,callback,triggerNow){var args=this._normalizeArguments(arguments);if(args.path!==undefined&&(typeof args.path!=='string'||args.path.length===0)){throw new Error('invalid argument path');}
if(typeof args.callback!=='function'){throw new Error('invalid argument callback');}
if(this._checkDestroyed('subscribe')){return;}
if(args.triggerNow){this.whenReady(function(){this._eventEmitter.on(args.path,args.callback);args.callback(this.get(args.path));}.bind(this));}else{this._eventEmitter.on(args.path,args.callback);}};Record.prototype.unsubscribe=function(pathOrCallback,callback){var args=this._normalizeArguments(arguments);if(args.path!==undefined&&(typeof args.path!=='string'||args.path.length===0)){throw new Error('invalid argument path');}
if(args.callback!==undefined&&typeof args.callback!=='function'){throw new Error('invalid argument callback');}
if(this._checkDestroyed('unsubscribe')){return;}
this._eventEmitter.off(args.path,args.callback);};Record.prototype.discard=function(){if(this._checkDestroyed('discard')){return;}
this.whenReady(function(){this.usages--;if(this.usages<=0){this.emit('destroyPending');this._discardTimeout=setTimeout(this._onTimeout.bind(this,C.EVENT.ACK_TIMEOUT),this._options.subscriptionTimeout);this._connection.sendMsg(C.TOPIC.RECORD,C.ACTIONS.UNSUBSCRIBE,[this.name]);}}.bind(this));};Record.prototype.delete=function(){if(this._checkDestroyed('delete')){return;}
this.whenReady(function(){this.emit('destroyPending');this._deleteAckTimeout=setTimeout(this._onTimeout.bind(this,C.EVENT.DELETE_TIMEOUT),this._options.recordDeleteTimeout);this._connection.sendMsg(C.TOPIC.RECORD,C.ACTIONS.DELETE,[this.name]);}.bind(this));};Record.prototype.whenReady=function(callback){if(this.isReady===true){callback(this);}else{this.once('ready',callback.bind(this,this));}};Record.prototype._$onMessage=function(message){if(message.action===C.ACTIONS.READ){if(this.version===null){clearTimeout(this._readTimeout);this._onRead(message);}else{this._applyUpdate(message,this._client);}}
else if(message.action===C.ACTIONS.ACK){this._processAckMessage(message);}
else if(message.action===C.ACTIONS.UPDATE||message.action===C.ACTIONS.PATCH){this._applyUpdate(message,this._client);}
else if(message.action===C.ACTIONS.WRITE_ACKNOWLEDGEMENT){var versions=JSON.parse(message.data[1]);for(var i=0;i<versions.length;i++){var callback=this._writeCallbacks[versions[i]];if(callback!==undefined){callback(messageParser.convertTyped(message.data[2],this._client))
delete this._writeCallbacks[versions[i]];}}}
else if(message.data[0]===C.EVENT.VERSION_EXISTS){this._recoverRecord(message.data[2],JSON.parse(message.data[3]),message);}
else if(message.data[0]===C.EVENT.MESSAGE_DENIED){this._clearTimeouts();}else if(message.action===C.ACTIONS.SUBSCRIPTION_HAS_PROVIDER){var hasProvider=messageParser.convertTyped(message.data[1],this._client);this.hasProvider=hasProvider;this.emit('hasProviderChanged',hasProvider);}};Record.prototype._recoverRecord=function(remoteVersion,remoteData,message){message.processedError=true;if(this._mergeStrategy){this._mergeStrategy(this,remoteData,remoteVersion,this._onRecordRecovered.bind(this,remoteVersion,remoteData,message));}
else{this.emit('error',C.EVENT.VERSION_EXISTS,'received update for '+remoteVersion+' but version is '+this.version);}};Record.prototype._sendUpdate=function(path,data,config){this.version++;var msgData;if(!path){msgData=config===undefined?[this.name,this.version,data]:[this.name,this.version,data,config];this._connection.sendMsg(C.TOPIC.RECORD,C.ACTIONS.UPDATE,msgData);}else{msgData=config===undefined?[this.name,this.version,path,messageBuilder.typed(data)]:[this.name,this.version,path,messageBuilder.typed(data),config];this._connection.sendMsg(C.TOPIC.RECORD,C.ACTIONS.PATCH,msgData);}};Record.prototype._onRecordRecovered=function(remoteVersion,remoteData,message,error,data){if(!error){var oldVersion=this.version;this.version=remoteVersion;var oldValue=this._$data;var newValue=jsonPath.set(oldValue,undefined,data,false);if(oldValue===newValue){return;}
var config=message.data[4];if(config&&JSON.parse(config).writeSuccess){var callback=this._writeCallbacks[oldVersion];delete this._writeCallbacks[oldVersion];this._setUpCallback(this.version,callback)}
this._sendUpdate(undefined,data,config);this._applyChange(newValue);}else{this.emit('error',C.EVENT.VERSION_EXISTS,'received update for '+remoteVersion+' but version is '+this.version);}};Record.prototype._processAckMessage=function(message){var acknowledgedAction=message.data[0];if(acknowledgedAction===C.ACTIONS.SUBSCRIBE){clearTimeout(this._readAckTimeout);}
else if(acknowledgedAction===C.ACTIONS.DELETE){this.emit('delete');this._destroy();}
else if(acknowledgedAction===C.ACTIONS.UNSUBSCRIBE){this.emit('discard');this._destroy();}};Record.prototype._applyUpdate=function(message){var version=parseInt(message.data[1],10);var data;if(message.action===C.ACTIONS.PATCH){data=messageParser.convertTyped(message.data[3],this._client);}else{data=JSON.parse(message.data[2]);}
if(this.version===null){this.version=version;}
else if(this.version+1!==version){if(message.action===C.ACTIONS.PATCH){this._connection.sendMsg(C.TOPIC.RECORD,C.ACTIONS.SNAPSHOT,[this.name]);}else{this._recoverRecord(version,data,message);}
return;}
this.version=version;this._applyChange(jsonPath.set(this._$data,message.action===C.ACTIONS.PATCH?message.data[2]:undefined,data));};Record.prototype._onRead=function(message){this.version=parseInt(message.data[1],10);this._applyChange(jsonPath.set(this._$data,undefined,JSON.parse(message.data[2])));this._setReady();};Record.prototype._setReady=function(){this.isReady=true;for(var i=0;i<this._queuedMethodCalls.length;i++){this[this._queuedMethodCalls[i].method].apply(this,this._queuedMethodCalls[i].args);}
this._queuedMethodCalls=[];this.emit('ready');};Record.prototype._setUpCallback=function(currentVersion,callback){var newVersion=Number(this.version)+1;this._writeCallbacks[newVersion]=callback;}
Record.prototype._sendRead=function(){this._connection.sendMsg(C.TOPIC.RECORD,C.ACTIONS.CREATEORREAD,[this.name]);};Record.prototype._applyChange=function(newData){if(this.isDestroyed){return;}
var oldData=this._$data;this._$data=newData;if(!this._eventEmitter._callbacks){return;}
var paths=Object.keys(this._eventEmitter._callbacks);for(var i=0;i<paths.length;i++){var newValue=jsonPath.get(newData,paths[i],false);var oldValue=jsonPath.get(oldData,paths[i],false);if(newValue!==oldValue){this._eventEmitter.emit(paths[i],this.get(paths[i]));}}};Record.prototype._normalizeArguments=function(args){if(args.length===1&&typeof args[0]==='object'){return args[0];}
var result=Object.create(null);for(var i=0;i<args.length;i++){if(typeof args[i]==='string'){result.path=args[i];}
else if(typeof args[i]==='function'){result.callback=args[i];}
else if(typeof args[i]==='boolean'){result.triggerNow=args[i];}}
return result;};Record.prototype._clearTimeouts=function(){clearTimeout(this._readAckTimeout);clearTimeout(this._deleteAckTimeout);clearTimeout(this._discardTimeout);clearTimeout(this._deleteAckTimeout);};Record.prototype._checkDestroyed=function(methodName){if(this.isDestroyed){this.emit('error','Can\'t invoke \''+methodName+'\'. Record \''+this.name+'\' is already destroyed');return true;}
return false;};Record.prototype._onTimeout=function(timeoutType){this._clearTimeouts();this.emit('error',timeoutType);};Record.prototype._destroy=function(){this._clearTimeouts();this._eventEmitter.off();this._resubscribeNotifier.destroy();this.isDestroyed=true;this.isReady=false;this._client=null;this._eventEmitter=null;this._connection=null;};module.exports=Record;},{"../constants/constants":11,"../message/message-builder":16,"../message/message-parser":17,"../utils/resubscribe-notifier":29,"../utils/utils":31,"./json-path":20,"component-emitter":2}],24:[function(_dereq_,module,exports){var C=_dereq_('../constants/constants'),AckTimeoutRegistry=_dereq_('../utils/ack-timeout-registry'),ResubscribeNotifier=_dereq_('../utils/resubscribe-notifier'),RpcResponse=_dereq_('./rpc-response'),Rpc=_dereq_('./rpc'),messageParser=_dereq_('../message/message-parser'),messageBuilder=_dereq_('../message/message-builder');var RpcHandler=function(options,connection,client){this._options=options;this._connection=connection;this._client=client;this._rpcs={};this._providers={};this._provideAckTimeouts={};this._ackTimeoutRegistry=new AckTimeoutRegistry(client,C.TOPIC.RPC,this._options.subscriptionTimeout);this._resubscribeNotifier=new ResubscribeNotifier(this._client,this._reprovide.bind(this));};RpcHandler.prototype.provide=function(name,callback){if(typeof name!=='string'||name.length===0){throw new Error('invalid argument name');}
if(this._providers[name]){throw new Error('RPC '+name+' already registered');}
if(typeof callback!=='function'){throw new Error('invalid argument callback');}
this._ackTimeoutRegistry.add(name,C.ACTIONS.SUBSCRIBE);this._providers[name]=callback;this._connection.sendMsg(C.TOPIC.RPC,C.ACTIONS.SUBSCRIBE,[name]);};RpcHandler.prototype.unprovide=function(name){if(typeof name!=='string'||name.length===0){throw new Error('invalid argument name');}
if(this._providers[name]){delete this._providers[name];this._ackTimeoutRegistry.add(name,C.ACTIONS.UNSUBSCRIBE);this._connection.sendMsg(C.TOPIC.RPC,C.ACTIONS.UNSUBSCRIBE,[name]);}};RpcHandler.prototype.make=function(name,data,callback){if(typeof name!=='string'||name.length===0){throw new Error('invalid argument name');}
if(typeof callback!=='function'){throw new Error('invalid argument callback');}
var uid=this._client.getUid(),typedData=messageBuilder.typed(data);this._rpcs[uid]=new Rpc(this._options,callback,this._client);this._connection.sendMsg(C.TOPIC.RPC,C.ACTIONS.REQUEST,[name,uid,typedData]);};RpcHandler.prototype._getRpc=function(correlationId,rpcName,rawMessage){var rpc=this._rpcs[correlationId];if(!rpc){this._client._$onError(C.TOPIC.RPC,C.EVENT.UNSOLICITED_MESSAGE,rawMessage);return null;}
return rpc;};RpcHandler.prototype._respondToRpc=function(message){var name=message.data[0],correlationId=message.data[1],data=null,response;if(message.data[2]){data=messageParser.convertTyped(message.data[2],this._client);}
if(this._providers[name]){response=new RpcResponse(this._connection,name,correlationId);this._providers[name](data,response);}else{this._connection.sendMsg(C.TOPIC.RPC,C.ACTIONS.REJECTION,[name,correlationId]);}};RpcHandler.prototype._$handle=function(message){var rpcName,correlationId,rpc;if(message.action===C.ACTIONS.REQUEST){this._respondToRpc(message);return;}
if(message.action===C.ACTIONS.ACK&&(message.data[0]===C.ACTIONS.SUBSCRIBE||message.data[0]===C.ACTIONS.UNSUBSCRIBE)){this._ackTimeoutRegistry.clear(message);return;}
if(message.action===C.ACTIONS.ERROR){if(message.data[0]===C.EVENT.MESSAGE_PERMISSION_ERROR){return;}
if(message.data[0]===C.EVENT.MESSAGE_DENIED&&message.data[2]===C.ACTIONS.SUBSCRIBE){this._ackTimeoutRegistry.remove(message.data[1],C.ACTIONS.SUBSCRIBE);return;}}
if(message.action===C.ACTIONS.ERROR||message.action===C.ACTIONS.ACK){if(message.data[0]===C.EVENT.MESSAGE_DENIED&&message.data[2]===C.ACTIONS.REQUEST){correlationId=message.data[3];}else{correlationId=message.data[2];}
rpcName=message.data[1];}else{rpcName=message.data[0];correlationId=message.data[1];}
rpc=this._getRpc(correlationId,rpcName,message.raw);if(rpc===null){return;}
if(message.action===C.ACTIONS.ACK){rpc.ack();}
else if(message.action===C.ACTIONS.RESPONSE){rpc.respond(message.data[2]);delete this._rpcs[correlationId];}
else if(message.action===C.ACTIONS.ERROR){message.processedError=true;rpc.error(message.data[0]);delete this._rpcs[correlationId];}};RpcHandler.prototype._reprovide=function(){for(var rpcName in this._providers){this._connection.sendMsg(C.TOPIC.RPC,C.ACTIONS.SUBSCRIBE,[rpcName]);}};module.exports=RpcHandler;},{"../constants/constants":11,"../message/message-builder":16,"../message/message-parser":17,"../utils/ack-timeout-registry":27,"../utils/resubscribe-notifier":29,"./rpc":26,"./rpc-response":25}],25:[function(_dereq_,module,exports){var C=_dereq_('../constants/constants'),utils=_dereq_('../utils/utils'),messageBuilder=_dereq_('../message/message-builder');var RpcResponse=function(connection,name,correlationId){this._connection=connection;this._name=name;this._correlationId=correlationId;this._isAcknowledged=false;this._isComplete=false;this.autoAck=true;utils.nextTick(this._performAutoAck.bind(this));};RpcResponse.prototype.ack=function(){if(this._isAcknowledged===false){this._connection.sendMsg(C.TOPIC.RPC,C.ACTIONS.ACK,[C.ACTIONS.REQUEST,this._name,this._correlationId]);this._isAcknowledged=true;}};RpcResponse.prototype.reject=function(){this.autoAck=false;this._isComplete=true;this._isAcknowledged=true;this._connection.sendMsg(C.TOPIC.RPC,C.ACTIONS.REJECTION,[this._name,this._correlationId]);};RpcResponse.prototype.error=function(errorMsg){this.autoAck=false;this._isComplete=true;this._isAcknowledged=true;this._connection.sendMsg(C.TOPIC.RPC,C.ACTIONS.ERROR,[errorMsg,this._name,this._correlationId]);};RpcResponse.prototype.send=function(data){if(this._isComplete===true){throw new Error('Rpc '+this._name+' already completed');}
this.ack();var typedData=messageBuilder.typed(data);this._connection.sendMsg(C.TOPIC.RPC,C.ACTIONS.RESPONSE,[this._name,this._correlationId,typedData]);this._isComplete=true;};RpcResponse.prototype._performAutoAck=function(){if(this.autoAck===true){this.ack();}};module.exports=RpcResponse;},{"../constants/constants":11,"../message/message-builder":16,"../utils/utils":31}],26:[function(_dereq_,module,exports){var C=_dereq_('../constants/constants'),messageParser=_dereq_('../message/message-parser');var Rpc=function(options,callback,client){this._options=options;this._callback=callback;this._client=client;this._ackTimeout=setTimeout(this.error.bind(this,C.EVENT.ACK_TIMEOUT),this._options.rpcAckTimeout);this._responseTimeout=setTimeout(this.error.bind(this,C.EVENT.RESPONSE_TIMEOUT),this._options.rpcResponseTimeout);};Rpc.prototype.ack=function(){clearTimeout(this._ackTimeout);};Rpc.prototype.respond=function(data){var convertedData=messageParser.convertTyped(data,this._client);this._callback(null,convertedData);this._complete();};Rpc.prototype.error=function(errorMsg){this._callback(errorMsg);this._complete();};Rpc.prototype._complete=function(){clearTimeout(this._ackTimeout);clearTimeout(this._responseTimeout);};module.exports=Rpc;},{"../constants/constants":11,"../message/message-parser":17}],27:[function(_dereq_,module,exports){var C=_dereq_('../constants/constants'),EventEmitter=_dereq_('component-emitter');var AckTimeoutRegistry=function(client,topic,timeoutDuration){this._client=client;this._topic=topic;this._timeoutDuration=timeoutDuration;this._register={};};EventEmitter(AckTimeoutRegistry.prototype);AckTimeoutRegistry.prototype.add=function(name,action){var uniqueName=action?action+name:name;this.remove(name,action);this._register[uniqueName]=setTimeout(this._onTimeout.bind(this,uniqueName,name),this._timeoutDuration);};AckTimeoutRegistry.prototype.remove=function(name,action){var uniqueName=action?action+name:name;if(this._register[uniqueName]){this.clear({data:[action,name]});}};AckTimeoutRegistry.prototype.clear=function(message){var name=message.data[1];var uniqueName=message.data[0]+name;var timeout=this._register[uniqueName]||this._register[name];if(timeout){clearTimeout(timeout);}else{this._client._$onError(this._topic,C.EVENT.UNSOLICITED_MESSAGE,message.raw);}};AckTimeoutRegistry.prototype._onTimeout=function(uniqueName,name){delete this._register[uniqueName];var msg='No ACK message received in time for '+name;this._client._$onError(this._topic,C.EVENT.ACK_TIMEOUT,msg);this.emit('timeout',name);};module.exports=AckTimeoutRegistry;},{"../constants/constants":11,"component-emitter":2}],28:[function(_dereq_,module,exports){var C=_dereq_('../constants/constants');var ResubscribeNotifier=_dereq_('./resubscribe-notifier');var Listener=function(type,pattern,callback,options,client,connection){this._type=type;this._callback=callback;this._pattern=pattern;this._options=options;this._client=client;this._connection=connection;this._ackTimeout=setTimeout(this._onAckTimeout.bind(this),this._options.subscriptionTimeout);this._resubscribeNotifier=new ResubscribeNotifier(client,this._sendListen.bind(this));this._sendListen();this.destroyPending=false;};Listener.prototype.sendDestroy=function(){this.destroyPending=true;this._connection.sendMsg(this._type,C.ACTIONS.UNLISTEN,[this._pattern]);this._resubscribeNotifier.destroy();};Listener.prototype.destroy=function(){this._callback=null;this._pattern=null;this._client=null;this._connection=null;};Listener.prototype.accept=function(name){this._connection.sendMsg(this._type,C.ACTIONS.LISTEN_ACCEPT,[this._pattern,name]);}
Listener.prototype.reject=function(name){this._connection.sendMsg(this._type,C.ACTIONS.LISTEN_REJECT,[this._pattern,name]);}
Listener.prototype._createCallbackResponse=function(message){return{accept:this.accept.bind(this,message.data[1]),reject:this.reject.bind(this,message.data[1])}}
Listener.prototype._$onMessage=function(message){if(message.action===C.ACTIONS.ACK){clearTimeout(this._ackTimeout);}else if(message.action===C.ACTIONS.SUBSCRIPTION_FOR_PATTERN_FOUND){this._callback(message.data[1],true,this._createCallbackResponse(message));}else if(message.action===C.ACTIONS.SUBSCRIPTION_FOR_PATTERN_REMOVED){this._callback(message.data[1],false);}else{this._client._$onError(this._type,C.EVENT.UNSOLICITED_MESSAGE,message.data[0]+'|'+message.data[1]);}};Listener.prototype._sendListen=function(){this._connection.sendMsg(this._type,C.ACTIONS.LISTEN,[this._pattern]);};Listener.prototype._onAckTimeout=function(){this._client._$onError(this._type,C.EVENT.ACK_TIMEOUT,'No ACK message received in time for '+this._pattern);};module.exports=Listener;},{"../constants/constants":11,"./resubscribe-notifier":29}],29:[function(_dereq_,module,exports){var C=_dereq_('../constants/constants');var ResubscribeNotifier=function(client,resubscribe){this._client=client;this._resubscribe=resubscribe;this._isReconnecting=false;this._connectionStateChangeHandler=this._handleConnectionStateChanges.bind(this);this._client.on('connectionStateChanged',this._connectionStateChangeHandler);};ResubscribeNotifier.prototype.destroy=function(){this._client.removeListener('connectionStateChanged',this._connectionStateChangeHandler);this._connectionStateChangeHandler=null;this._client=null;};ResubscribeNotifier.prototype._handleConnectionStateChanges=function(){var state=this._client.getConnectionState();if(state===C.CONNECTION_STATE.RECONNECTING&&this._isReconnecting===false){this._isReconnecting=true;}
if(state===C.CONNECTION_STATE.OPEN&&this._isReconnecting===true){this._isReconnecting=false;this._resubscribe();}};module.exports=ResubscribeNotifier;},{"../constants/constants":11}],30:[function(_dereq_,module,exports){var C=_dereq_('../constants/constants'),ResubscribeNotifier=_dereq_('./resubscribe-notifier');var SingleNotifier=function(client,connection,topic,action,timeoutDuration){this._client=client;this._connection=connection;this._topic=topic;this._action=action;this._timeoutDuration=timeoutDuration;this._requests={};this._resubscribeNotifier=new ResubscribeNotifier(this._client,this._resendRequests.bind(this));};SingleNotifier.prototype.hasRequest=function(name){return!!this._requests[name];};SingleNotifier.prototype.request=function(name,callback){var responseTimeout;if(!this._requests[name]){this._requests[name]=[];this._connection.sendMsg(this._topic,this._action,[name]);}
responseTimeout=setTimeout(this._onResponseTimeout.bind(this,name),this._timeoutDuration);this._requests[name].push({timeout:responseTimeout,callback:callback});};SingleNotifier.prototype.recieve=function(name,error,data){var entries=this._requests[name];if(!entries){this._client._$onError(this._topic,C.EVENT.UNSOLICITED_MESSAGE,'no entry for '+name);return;}
for(i=0;i<entries.length;i++){entry=entries[i];clearTimeout(entry.timeout);entry.callback(error,data);}
delete this._requests[name];};SingleNotifier.prototype._onResponseTimeout=function(name){var msg='No response received in time for '+this._topic+'|'+this._action+'|'+name;this._client._$onError(this._topic,C.EVENT.RESPONSE_TIMEOUT,msg);};SingleNotifier.prototype._resendRequests=function(){for(var request in this._requests){this._connection.sendMsg(this._topic,this._action,[this._requests[request]]);}};module.exports=SingleNotifier;},{"../constants/constants":11,"./resubscribe-notifier":29}],31:[function(_dereq_,module,exports){(function(process){var TRIM_REGULAR_EXPRESSION=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g;var OBJECT='object';exports.isNode=typeof process!=='undefined'&&process.toString()==='[object process]';exports.nextTick=function(fn){if(exports.isNode){process.nextTick(fn);}else{setTimeout(fn,0);}};exports.trim=function(inputString){if(inputString.trim){return inputString.trim();}else{return inputString.replace(TRIM_REGULAR_EXPRESSION,'');}};exports.deepEquals=function(objA,objB){if(objA===objB){return true}
else if(typeof objA!==OBJECT||typeof objB!==OBJECT){return false;}
else{return JSON.stringify(objA)===JSON.stringify(objB);}};exports.deepCopy=function(obj){if(typeof obj===OBJECT){return JSON.parse(JSON.stringify(obj));}else{return obj;}};exports.shallowCopy=function(obj){if(Array.isArray(obj)){return obj.slice(0);}
else if(typeof obj===OBJECT){var copy=Object.create(null);var props=Object.keys(obj);for(var i=0;i<props.length;i++){copy[props[i]]=obj[props[i]];}
return copy;}
return obj;}
exports.setTimeout=function(callback,timeoutDuration){if(timeoutDuration!==null){return setTimeout(callback,timeoutDuration);}else{return-1;}};exports.setInterval=function(callback,intervalDuration){if(intervalDuration!==null){return setInterval(callback,intervalDuration);}else{return-1;}};var hasUrlProtocol=/^wss:|^ws:|^\/\//;var unsupportedProtocol=/^http:|^https:/;var URL=_dereq_('url');exports.parseUrl=function(url,defaultPath){if(unsupportedProtocol.test(url)){throw new Error('Only ws and wss are supported');}
if(!hasUrlProtocol.test(url)){url='ws://'+url;}else if(url.indexOf('//')===0){url='ws:'+url;}
var serverUrl=URL.parse(url);if(!serverUrl.host){throw new Error('invalid url, missing host');}
serverUrl.protocol=serverUrl.protocol?serverUrl.protocol:'ws:';serverUrl.pathname=serverUrl.pathname?serverUrl.pathname:defaultPath;return URL.format(serverUrl);};}).call(this,_dereq_('_process'))},{"_process":3,"url":8}]},{},[10])(10)});